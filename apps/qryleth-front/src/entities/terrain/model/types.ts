/**
 * Доменные типы для системы террейна
 * 
 * Данный файл содержит типы для новой унифицированной системы ландшафтных слоев
 * с поддержкой различных источников данных (Perlin noise, heightmaps) и
 * системы модификаций террейна (TerrainOps).
 */

import type { GfxMultiColorConfig } from '@/entities/layer'

/**
 * Параметры для генерации Perlin noise
 * Все размеры указаны в сегментах сетки, а не в мировых координатах
 */
export interface GfxPerlinParams {
  /** Сид для детерминированной генерации шума */
  seed: number;
  /** Количество октав для генерации шума */
  octaveCount: number;
  /** Амплитуда шума (максимальная высота) */
  amplitude: number;
  /** Коэффициент затухания для октав */
  persistence: number;
  /** Ширина в сегментах сетки */
  width: number;
  /** Высота в сегментах сетки */
  height: number;
  /**
   * Смещение базового уровня высоты (DC-смещение) в метрах.
   * Позволяет опускать или поднимать весь базовый рельеф относительно Y=0.
   * Отрицательные значения опускают базу ниже нулевой плоскости/уровня моря.
   * По умолчанию 0 (смещение не применяется).
   */
  heightOffset?: number;
}

/**
 * Параметры для загруженной heightmap из PNG
 */
export interface GfxHeightmapParams {
  /** Идентификатор PNG блоба в Dexie */
  assetId: string;
  /** Ширина изображения в пикселях */
  imgWidth: number;
  /** Высота изображения в пикселях */
  imgHeight: number;
  /** Минимальная высота (уровень моря/нуля) */
  min: number;
  /** Максимальная высота */
  max: number;
  /** Режим обработки краев UV координат */
  wrap?: 'clamp' | 'repeat';
}

/**
 * Источник данных для геометрии террейна
 */
export type GfxTerrainSource =
  | { kind: 'perlin'; params: GfxPerlinParams }
  | { kind: 'heightmap'; params: GfxHeightmapParams };

/**
 * Одна операция модификации рельефа
 */
export interface GfxTerrainOp {
  /** Уникальный идентификатор для редактирования/удаления */
  id: string;
  /** Режим применения смещения */
  mode: 'add' | 'sub' | 'set';
  /** Форма зоны влияния: эллипс (по умолчанию) или прямоугольник */
  shape?: 'ellipse' | 'rect';
  /**
   * Центр операции в ЛОКАЛЬНЫХ координатах террейна [x, z].
   * Локальные координаты считаются относительно `GfxTerrainConfig.center`.
   * Это позволяет использовать один и тот же набор операций для разных
   * слоёв, просто меняя центр террейна.
   */
  center: [number, number];
  /** Сферический радиус влияния в мировых единицах */
  radius: number;
  /** Амплитуда изменения высоты (+/-) */
  intensity: number;
  /**
   * Функция затухания эффекта.
   * - 'smoothstep' — плавные края, универсальный выбор
   * - 'gauss' — острая вершина с быстрым спадом к краям
   * - 'linear' — линейный спад, даёт более плоскую вершину относительно центра
   * - 'plateau' — «плато» с плоским ядром и спадом к краям (см. flatInner)
   */
  falloff?: 'smoothstep' | 'gauss' | 'linear' | 'plateau';
  /**
   * Доля «плоского ядра» для falloff='plateau' (0..1).
   * Интерпретация через параметр t из applyFalloffFunction: t=1 — центр фигуры, t=0 — край.
   * Значение flatInner определяет порог t, начиная с которого функция насыщена (=1).
   *
   * Пример: flatInner=0.9 → плоская площадка почти до края с узким обрывом (≈10% внешнего радиуса).
   * При других falloff игнорируется.
   */
  flatInner?: number;
  /** Радиус по оси Z для эллиптических операций (опционально) */
  radiusZ?: number;
  /** Поворот эллипса в радианах (опционально) */
  rotation?: number;
}

/**
 * Конфигурация параметров адаптивной тесселляции
 */
export interface GfxAdaptiveTessellationConfig {
  /** Включить адаптивную тесселляцию */
  enabled: boolean;
  /** Максимальная длина стороны треугольника в мировых единицах */
  maxEdgeLength?: number;
  /** Максимальная разность высот в треугольнике для разделения */
  maxHeightDifference?: number;
  /** Максимальное количество итераций разбиения */
  maxIterations?: number;
  /** Минимальный размер треугольника (для предотвращения бесконечного деления) */
  minTriangleSize?: number;
  /** Порог сложности рельефа для автоматического включения (0.0-1.0) */
  complexityThreshold?: number;
  /** Минимальная площадь террейна для автоматического включения */
  minAreaThreshold?: number;
}

/**
 * Полная конфигурация террейна слоя
 */
export interface GfxTerrainConfig {
  /** Ширина области в мировых координатах */
  worldWidth: number;
  /**
   * Глубина области в мировых координатах (ось Z).
   *
   * Исторически это поле называлось worldHeight, что вводило в заблуждение,
   * поскольку речь идёт не о вертикальной «высоте» (ось Y), а о размере по Z.
   * Теперь используется корректное название worldDepth.
   */
  worldDepth: number;
  /**
   * Центр террейна в мировых координатах [x, z].
   *
   * Если не указан — по умолчанию считается [0, 0], то есть террейн
   * будет симметрично располагаться вокруг мирового центра сцены.
   * Указание центра позволяет создавать несколько независимых ландшафтных
   * слоёв, каждый из которых строится вокруг собственной опорной точки.
   */
  center?: [number, number];
  /** Плавный спад к краям (0..1 доля от края) */
  edgeFade?: number;
  /**
   * Уровень моря в метрах (опционально). Используется для согласования визуализации воды
   * и поведения систем, зависящих от опорного нуля. По умолчанию считается равным 0.
   */
  seaLevel?: number;
  /** Источник базовых данных высот */
  source: GfxTerrainSource;
  /** Массив операций модификации террейна */
  ops?: GfxTerrainOp[];
  /** 
   * Конфигурация адаптивной тесселляции для оптимизации геометрии 
   * при резких перепадах высот
   */
  adaptiveTessellation?: GfxAdaptiveTessellationConfig;
}

/**
 * Интерфейс для получения высоты и нормалей террейна
 * Единый источник данных о высотах для рендеринга и размещения объектов
 */
export interface GfxHeightSampler {
  /**
   * Получить высоту в указанной точке мировых координат
   * @param x - координата X в мировой системе координат
   * @param z - координата Z в мировой системе координат
   * @returns высота Y в мировых единицах
   */
  getHeight(x: number, z: number): number;

  /**
   * Получить нормаль поверхности в указанной точке
   * Вычисляется через конечные разности (центральные/встречные)
   * @param x - координата X в мировой системе координат
   * @param z - координата Z в мировой системе координат
   * @returns нормализованный вектор нормали [nx, ny, nz]
   */
  getNormal(x: number, z: number): [number, number, number];

  /**
   * Зарегистрировать колбэк, который будет вызван после асинхронной загрузки данных heightmap.
   *
   * Используется UI-слоями для повторной генерации геометрии после того, как PNG
   * будет прочитан из Dexie и преобразован в ImageData. Для источников отличных от
   * heightmap метод может быть не реализован.
   */
  onHeightmapLoaded?(callback: () => void): void;

  /**
   * Проверить готовность источника высот.
   * Возвращает true, если источник синхронный (Perlin) или данные heightmap уже загружены.
   */
  isReady?(): boolean;

  /**
   * Дождаться готовности источника высот.
   * Для Perlin-источника выполняется мгновенно; для heightmap — после загрузки данных.
   */
  ready?(): Promise<void>;

  /**
   * Освободить ресурсы, связанные с сэмплером (подписки, временные ссылки).
   * Геометрии/материалы Three.js освобождаются отдельно в рендер-слоях.
   */
  dispose?(): void;
}

/**
 * Ландшафтная площадка в новой архитектуре: описывает один участок ландшафта,
 * который может быть плоским (plane) или террейном (terrain) с источником данных.
 *
 * Площадки ландшафта хранятся в контейнере содержимого сцены, привязанном к
 * тонкому слою через `layerId`. Один слой ландшафта может содержать несколько
 * таких площадок.
 */
export interface GfxLandscape {
  /** Уникальный идентификатор площадки в пределах слоя */
  id: string
  /** Человекочитаемое имя площадки (для UI) */
  name?: string
  /** Форма площадки: плоскость или террейн */
  shape: 'plane' | 'terrain'
  /** Размеры площадки в мировых координатах */
  size: { width: number; depth: number }
  /** Центр площадки в мировых координатах XZ (опционально) */
  center?: [number, number]
  /** Конфигурация террейна, если shape = 'terrain' */
  terrain?: GfxTerrainConfig
  /**
   * Описание простого материала: одноцветный или многоцветный по высоте.
   * Если задан multiColor — имеет приоритет над color.
   */
  material?: { color?: string; multiColor?: GfxMultiColorConfig }
}
