import type { Point2, Rect2D, Circle2D, BoundRect2D } from '@/shared/types'

/**
 * GfxBiome — доменная сущность биома сцены.
 *
 * Биом описывает:
 * - Область на плоскости XZ (вид сверху), где генерируются инстансы
 * - Правила источников (отбор объектов из библиотеки по тегам/типам)
 * - Параметры алгоритма и плотности через spacing (random/poisson, seed)
 * - Поведение у краёв области (fade/bias)
 * - Случайные трансформации для инстансов (вращение/масштаб/смещения)
 */
export interface GfxBiome {
  /** Уникальный идентификатор биома */
  uuid: string
  /** Человекочитаемое имя биома */
  name: string
  /** Геометрия области действия биома */
  area: GfxBiomeArea
  /** Виден ли слой биома (для отладки/включения-выключения скаттеринга) */
  visible?: boolean
  /** Дефолтная конфигурация скаттеринга биома (алгоритм, spacing, edge/transform/source) */
  scattering: GfxBiomeScatteringConfig
  /**
   * Стратификация биома: набор слоёв (strata), внутри каждого — правила размещения.
   *
   * На первой итерации (скелет) правила не переопределяют глобальные параметры
   * биома и служат для структурирования. В следующих итерациях правила
   * получат локальные параметры (density/edge/transform/sourceSelection).
   */
  strata?: GfxBiomeStratum[]
}

/**
 * Область биома: набор поддерживаемых форм на плоскости XZ.
 *
 * Для простоты используем осевые формы с опциональным поворотом у прямоугольника
 * и произвольные многоугольники (список точек).
 */
export type GfxBiomeArea =
  | GfxBiomeRectArea
  | GfxBiomeCircleArea
  | GfxBiomePolygonArea

/**
 * Страта биома: логический слой размещения (например, деревья/кусты/трава).
 * Содержит частичный оверрайд конфигурации скаттеринга относительно биомных дефолтов.
 */
export interface GfxBiomeStratum {
  /** Имя страты (для UI/логов) */
  name: string
  /** Частичный оверрайд настроек скаттеринга для страты */
  scattering?: Partial<GfxBiomeScatteringConfig>
}

// Удалены правила внутри страты: в v2 страта представлена единичным частичным оверрайдом конфигурации

/**
 * Прямоугольная область биома.
 *
 * Использует осевой прямоугольник на XZ и опциональный поворот вокруг оси Y
 * (в градусах). Поворот применяется вокруг центра прямоугольника.
 */
export interface GfxBiomeRectArea {
  type: 'rect'
  /** Оси‑выровненный прямоугольник на XZ */
  rect: Rect2D
  /** Поворот области вокруг Y (градусы), по умолчанию 0 */
  rotationY?: number
}

/**
 * Круговая область биома.
 */
export interface GfxBiomeCircleArea {
  type: 'circle'
  circle: Circle2D
}

/**
 * Произвольная многоугольная область биома.
 *
 * Точки задаются в плоскости XZ. Для ускорения проверок может храниться
 * предвычислённый ограничивающий прямоугольник.
 */
export interface GfxBiomePolygonArea {
  type: 'polygon'
  /** Список вершин многоугольника [x, z] в порядке обхода */
  points: Point2[]
  /** Предвычисленный ограничивающий прямоугольник (опционально) */
  bounds?: BoundRect2D
}

/**
 * Настройки скаттеринга биома: отбор источников, плотность/распределение, края и рандомизация.
 */
export type GfxScatterAlgorithm = 'random' | 'poisson'

/**
 * Конфигурация скаттеринга v2: алгоритм, spacing, опциональные edge/transform/source и seed.
 *
 * - spacing — единственный канонический параметр плотности (единицы сцены)
 * - algorithm — 'random' | 'poisson'
 * - edge/transform/source — опциональны; при отсутствии применяются дефолты/полная библиотека
 */
export interface GfxBiomeScatteringConfig {
  /** Алгоритм генерации точек */
  algorithm: GfxScatterAlgorithm
  /** Seed для детерминизма (базовый для биома) */
  seed?: number
  /** Минимально желаемая дистанция между точками (единицы сцены) */
  spacing: number
  /** Настройки поведения у границ области (опционально) */
  edge?: GfxBiomeEdgeFalloff
  /** Рандомизация трансформаций (опционально) */
  transform?: GfxBiomePlacementTransform
  /**
   * Поверхностная маска для отбора и модуляции плотности по параметрам террейна (опционально).
   *
   * Если НЕ задана — скаттеринг работает как прежде (без учёта террейна на
   * этапе генерации точек). Если задана — по каждой кандидатной точке
   * вычисляется фактор пригодности на основе высоты, наклона и/или кривизны
   * поверхности, и в зависимости от режима (mode) применяется:
   *  - reject: жёсткая отбраковка точек вне диапазонов;
   *  - weight: вероятностный отбор с весом W∈[0..1];
   *  - spacing: адаптивный локальный интервал (уменьшение/увеличение плотности).
   */
  surface?: GfxBiomeSurfaceMask
  /** Фильтр источников (опционально); если не указан — вся библиотека */
  source?: GfxBiomeSourceFilter
}

/**
 * Поверхностная маска (terrain-aware): управляет отбором и локальной плотностью
 * размещения на основе параметров рельефа.
 */
export interface GfxBiomeSurfaceMask {
  /**
   * Ограничение по высоте. По умолчанию интерпретация — абсолютная мировая высота (Y, reference='world').
   * Можно указать reference='seaLevel' — тогда высота нормируется относительно уровеня моря слоя.
   * Также допустимо задать числовой reference (смещение) для специфичных случаев.
   */
  height?: {
    /** Допустимый диапазон высот [min, max] */
    range?: [number, number]
    /** «Мягкость» границ (0..1): 0 — резкий порог, >0 — сглаженные края через S‑кривую */
    soft?: number
    /** Система отсчёта высоты: 'world' | 'seaLevel' | число (смещение относительно world) */
    reference?: 'world' | 'seaLevel' | number
  }
  /**
   * Ограничение по наклону (в градусах): угол между нормалью и вертикалью (осью Y).
   * Пример: [0, 28] — разрешать только пологие склоны.
   */
  slopeDeg?: {
    range?: [number, number]
    soft?: number
  }
  /**
   * Ограничение по кривизне: степень «изломанности» поверхности (вторая производная рельефа).
   * Используется для исключения резких перегибов (деревья) или, наоборот, их предпочтения (камни).
   * step — шаг дискретизации в мировых единицах для численного расчёта кривизны.
   */
  curvature?: {
    range?: [number, number]
    soft?: number
    step?: number
  }
  /**
   * Режим(ы) применения маски. Можно комбинировать несколько режимов одновременно.
   * - 'reject'  — жёсткая отбраковка точек вне диапазонов;
   * - 'weight'  — вероятностный отбор по весу W∈[0..1];
   * - 'spacing' — модификация локального spacing через spacingScale.
   */
  mode?: Array<'reject' | 'weight' | 'spacing'>
  /**
   * Правило объединения нескольких факторов (height/slope/curvature) в единый вес W.
   * - 'mul' — перемножение (дефолтная рекомендуемая стратегия);
   * - 'min' | 'max' — минимальное/максимальное из факторов;
   * - 'avg' — среднее арифметическое.
   */
  combine?: 'mul' | 'min' | 'max' | 'avg'
  /** Веса вкладов факторов при объединении (если актуально для выбранного combine). */
  weight?: {
    byHeight?: number
    bySlope?: number
    byCurvature?: number
  }
  /**
   * Масштаб для адаптивного локального spacing при режиме 'spacing'.
   * minFactor < 1.0 — уплотнение в «хороших» местах; maxFactor > 1.0 — разрежение в «плохих».
   */
  spacingScale?: {
    minFactor?: number
    maxFactor?: number
  }
}

/**
 * Фильтры источников объектов для скаттеринга биома.
 *
 * Биом выбирает объекты из библиотеки по:
 * - тегам (вхождение хотя бы одного/всех, исключение)
 * - типам примитивов (например, 'box'|'sphere' и т.д. в составе объекта)
 * - явному списку UUID записей библиотеки
 * А также позволяет назначать веса через UUID или тег.
 */
export interface GfxBiomeSourceFilter {
  /** Обязательные теги: объект должен содержать все эти теги */
  requiredTags?: string[]
  /** Достаточные теги: объект должен содержать хотя бы один из этих тегов */
  anyTags?: string[]
  /** Теги‑исключения: объект с такими тегами исключается из выборки */
  excludeTags?: string[]
  /** Явное включение записей библиотеки по их UUID (приоритетнее фильтров) */
  includeLibraryUuids?: string[]
  /** Веса для UUID записей библиотеки (усиливают шанс выбора конкретной записи) */
  weightsByLibraryUuid?: Record<string, number>
  /** Веса для тегов (повышают шанс объектов с указанными тегами) */
  weightsByTag?: Record<string, number>
}

/**
 * Поведение на краях области биома: fade и bias.
 *
 * - fadeWidth — ширина зоны затухания от границы внутрь области (в единицах сцены)
 * - fadeCurve — профиль затухания (линейный или плавный)
 * - edgeBias — смещение вероятности: -1 тянет к краям, +1 к центру, 0 без смещения
 */
export interface GfxBiomeEdgeFalloff {
  /** Ширина зоны затухания от границы внутрь области */
  fadeWidth: number
  /** Профиль затухания по краю */
  fadeCurve?: 'linear' | 'smoothstep'
  /**
   * Сила эффекта края: [-1..1].
   *  0  — равномерно (без эффекта края)
   *  0..1 — предпочтение центра: 0.5 наполовину, 1 — полный fade у кромки
   *  -1..0 — предпочтение кромки: -1 — сильнее у края
   */
  edgeBias?: number // -1..1
}

/**
 * Рандомизация трансформаций инстансов при размещении.
 */
export interface GfxBiomePlacementTransform {
  /** Случайное вращение вокруг Y: [min, max] в градусах. По умолчанию [0, 360] */
  randomYawDeg?: [number, number]
  /** Случайный масштаб: [min, max]. По умолчанию [1, 1] (без изменений) */
  randomUniformScale?: [number, number]
  /** Локальные случайные смещения по XZ в пределах указанного диапазона */
  randomOffsetXZ?: [number, number]
  /**
   * Автоповорот инстанса по нормали к поверхности террейна.
   *
   * Если задан, при создании инстансов (этап применения скаттеринга к сцене)
   * объект дополнительно наклоняется по нормали поверхности в точке размещения.
   * Величина наклона ограничивается максимальным углом, а также может
   * дополнительно ослабляться на участках с большой кривизной (резкими перепадами).
   */
  alignToSurfaceNormal?: {
    /**
     * Максимальный угол отклонения (в градусах) при 90° наклоне поверхности.
     * Фактический наклон плавно масштабируется от 0° (горизонтальная площадка)
     * до указанного значения (крутой склон), без «упора в максимум».
     * По умолчанию используется значение по умолчанию из подсистемы размещения.
     */
    maxDeviationDeg?: number
    /**
     * Влияние кривизны поверхности на наклон [0..1].
     * 0 — игнорировать кривизну (использовать только наклон);
     * 1 — максимально подавлять наклон на сильно изогнутых участках.
     * Реализация: maxDeviationRad умножается на (1 - curvature * influence).
     */
    curvatureInfluence?: number
  }
}
