# SceneEditor R3F

Описание работы редактора сцены и его составных частей.

## Функциональное устройство
- Компонент `SceneEditorR3F` объединяет окно чата с ИИ, канвас Three.js и менеджер объектов.
- При загрузке страницы через `useEffect` считывает сцену из IndexedDB (если передан `uuid`) или очищает состояние для новой сцены.
- Обработчики `handleSceneGenerated` и `handleObjectAdded` принимают данные от `ChatInterface` и обновляют состояние сцены.
- Кнопки в правом верхнем углу позволяют отменять/повторять действия (`undo`/`redo`) и открывать настройки.
- Панель инструментов над канвасом переключает режим отображения (`renderMode`), способ перемещения камеры (`viewMode`) и активный инструмент трансформации (`transformMode`).
- Сохранение сцены в библиотеку происходит через `SaveSceneModal` и функции `db.saveScene`/`db.updateScene`.
- Объекты можно редактировать во всплывающем `ObjectEditorR3F`, вызов которого осуществляется из `ObjectManager`.

## Используемые типы
SceneEditor оперирует типами из [types.md](types.md):
- **SceneObject**, **SceneObjectInstance** – описывают объекты и их инстансы на сцене; используются при добавлении объектов и обновлении размещений.
- **SceneResponse** – применяется для загрузки сгенерированной ИИ сцены целиком (`handleSceneGenerated`).
- **SceneStatus** и **CurrentScene** – отражают состояние текущей сцены и выводятся в шапке редактора.
- **ViewMode**, **RenderMode**, **TransformMode** – определяют режим камеры, способ рендера и активный инструмент.
- **SelectedObject** и **HoveredObject** – используются внутри стора для подсветки и выделения элементов.

## Данные из хранилища
Состояние редактора поступает из `sceneStore` (см. [store.md](store.md)):
- **objects**, **placements**, **layers**, **lighting** – основное содержимое сцены. Используются для рендера (`Scene3D`) и в панели `ObjectManager`.
- **viewMode**, **renderMode**, **transformMode**, **gridVisible** – параметры управления камерой и отображением, меняются через панель инструментов.
- **selectedObject**, **hoveredObject** – позволяют подсвечивать и редактировать объекты.
- **currentScene** – метаданные (имя, статус, uuid) для отображения статуса и сохранения сцены.
- **history**, **historyIndex** – служат для функции `undo`/`redo` (используются в хуке `useSceneHistory`).

## Вложенные компоненты
- **ChatInterface** – виджет общения с агентом. Возвращает готовую сцену (`SceneResponse`) или новые объекты через `onSceneGenerated`/`onObjectAdded`.
- **Scene3D** – холст Three.js. Внутри рендерит `SceneContent`, который включает освещение, контролы камеры, объекты и пост‑обработку.
- **ObjectManager** – панель управления слоями, объектами и освещением. Позволяет создавать/редактировать слои и открывать `ObjectEditorR3F`.
- **OpenAISettingsModal** – всплывающее окно с настройками подключения к LLM.
- **ObjectEditorR3F** – редактор выбранного объекта; открывается для правки примитивов и сохраняет изменения в стор.
- **SaveSceneModal** – локальный модал для ввода названия и описания перед сохранением сцены в библиотеку.
