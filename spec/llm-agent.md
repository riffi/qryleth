# Взаимодействие LLM-агента с редактором

Документ описывает, как языковая модель взаимодействует с Qryleth и какие правила необходимо соблюдать.

## Принцип работы
- Компонент `ChatInterface` отправляет сообщения пользователя через функцию `fetchWithTools` из `src/shared/lib/openAIAPI.ts`.
- Модель получает определение инструментов из константы `AVAILABLE_TOOLS` и может вызывать их посредством `tool_calls`.
- Результат запроса содержит текстовый ответ и, при необходимости, набор вызовов инструментов (`ToolCall`).
- Логика обработки `ToolCall` реализована в UI (см. `handleToolCalls` в `ChatInterface`). Она вызывает публичные actions zustand‑сторов или переданные в пропсы коллбеки.
- Агент не изменяет DOM напрямую и не обращается к внутреннему состоянию компонентов.

## Контракт
- Структуры данных для общения с моделью определены в `openAIAPI.ts`:
  - `ChatMessage` – роль, текст и время сообщения.
  - `Tool` – описание инструмента, который может быть вызван моделью.
  - `ToolCall` – фактический вызов с именем функции и аргументами.
  - `ChatResponse` – ответ модели, содержащий текст и список `ToolCall`.
- На данный момент поддерживается инструмент `add_new_object` с параметрами, описанными в `AVAILABLE_TOOLS`.
- Модель обязана передавать аргументы в формате JSON, соответствующем схемам параметров инструментов. Неверный формат считается ошибкой.
- Все манипуляции со сценой должны выполняться через публичные функции стора или пропсы компонентов (например, `onObjectAdded`).

## Пример последовательности
1. Пользователь отправляет запрос в чат.
2. `ChatInterface` добавляет сообщение в список и вызывает `fetchWithTools` с накопленной историей сообщений и инструментами.
3. В ответе модель может вернуть `tool_calls`. Для `add_new_object` UI создаёт объект и сообщает об успешном действии отдельным сообщением.

Такой подход гарантирует, что агенты работают предсказуемо и не нарушают архитектурные границы приложения.
