---
id: 18
epic: null
title: "Heightmap: массив высот в Dexie, масштабирование ≤200x200, выбор из коллекции, прелоадер применения"
status: in-progress
created: 2025-08-22
updated: 2025-08-22
owner: ai-agent
tags: [terrain, heightmap, dexie, ui, r3f]
phases:
  total: 6
  completed: 4
---

# Heightmap: массив высот в Dexie, масштабирование ≤200x200, выбор из коллекции, прелоадер применения

## Обязательная информация
!Правила работы с агентскими задачами: [agent-tasks.md](../../../../docs/development/workflows/agent-tasks.md)
ВАЖНО: При выполнении каждой из фаз необходимо сверяться с принципами из [design-principles.md](../../../../docs/architecture/design-principles.md).

## Цели
- Добавить к таблице `terrainAssets` хранение массива высот (Float32Array), извлечённых из PNG.
- При импорте PNG масштабировать изображение до не более 200×200 px; высотный массив должен соответствовать этому размеру.
- В `LayerModals` добавить возможность выбора heightmap из коллекции Dexie (новое модальное окно-пикер с превью).
- При загрузке карты высот на сцену блокировать рендер и показывать прелоадер до применения карты.

## Контекст
Текущая реализация хранит в Dexie только PNG blob и при использовании источника `heightmap` загружает `ImageData` в рантайме (`HeightmapUtils.loadTerrainAssetImageData`), после чего сэмплирует яркость с bilinear-интерполяцией. UI создания слоя поддерживает загрузку PNG через `FileInput`, но нет выбора из уже загруженных ассетов, а применение карты происходит асинхронно без явного блокирования рендера/индикации процесса. Требуется оптимизировать хранение и загрузку (готовый массив высот), ограничить размер входной карты и расширить UX.

## Список фаз

### ✅ Фаза 1: Схема Dexie и утилиты высот
- Расширить `TerrainAssetRecord` добавлением полей для высот и их размеров:
  - `heights?: Float32Array | ArrayBuffer` (хранение в IndexedDB через Dexie);
  - `heightsWidth?: number`, `heightsHeight?: number` (реальный размер сетки высот после масштабирования);
  - при проектировании учесть, что Dexie может сохранять `ArrayBuffer`; при чтении восстанавливать `Float32Array`.
- Добавить helper в `HeightmapUtils` для извлечения массива высот из `ImageData`:
  - Luminance: `Y = 0.2126R + 0.7152G + 0.0722B`;
  - Нормализация в диапазон `[min..max]` при необходимости параметрами функции;
  - Выдавать `Float32Array` размера `w*h`.
- Обеспечить обратную совместимость чтения ассетов без `heights` (ленивое заполнение на первой загрузке; см. Фаза 2).

**Отчёт**: [phases/phase_1_summary.md](phases/phase_1_summary.md)

### ✅ Фаза 2: Масштабирование PNG ≤200×200 и первичное заполнение высот
- Изменить `uploadTerrainAsset(file)` в `HeightmapUtils`:
  - после валидации загрузить `ImageBitmap`, вычислить `targetWidth/targetHeight` с сохранением пропорций и ограничением по максимуму 200;
  - отрисовать с ресайзом на `canvas`, получить `ImageData` именно масштабированного изображения;
  - извлечь `Float32Array` высот из масштабированного `ImageData`;
  - сохранить в Dexie: новый blob PNG (сжатый из канваса) соответствующего масштаба, `width/height` и `heights`, `heightsWidth/Height`.
- Добавить «ленивую миграцию» для старых записей без `heights`:
  - при первом запросе ассета: если `heights` отсутствует — вычислить из текущего blob с масштабированием ≤200×200, записать назад в Dexie.

**Отчёт**: [phases/phase_2_summary.md](phases/phase_2_summary.md)

### ✅ Фаза 3: GfxHeightSampler — выбор источника данных на основе массива высот
- В `GfxHeightSampler` добавить путь сэмплинга из `heights` (если есть) с bilinear интерполяцией по `heightsWidth/Height`.
- Предпочитать `heights` перед `ImageData`; если `heights` отсутствуют — текущая логика `ImageData` как fallback.
- Вынести билinear-интерполяцию по массиву чисел в отдельный метод с подробным комментарием на русском языке.
- Очистка и инвалидация локальных кэшей при поступлении `heights` после ленивой миграции.

**Отчёт**: [phases/phase_3_summary.md](phases/phase_3_summary.md)

### ✅ Фаза 4: UI — модал выбора карты высот из коллекции
- Создать `TerrainAssetPickerModal`:
  - грид карточек с превью (использовать `createTerrainAssetPreviewUrl`), названием, размерами, датой;
  - пагинация/скролл при большом количестве;
  - выбор одного ассета, кнопка «Выбрать» возвращает `assetId` и размеры.
- Интегрировать в `SceneLayerModals` (создание Terrain слоя):
  - рядом с `FileInput` добавить кнопку «Выбрать из коллекции» → открывает модал пикера;
  - по выбору ассета проставлять `assetId`, `imgWidth`, `imgHeight`; скрывать `FileInput` (или оставить альтернативой);
  - предусмотреть сброс выбора.

**Отчёт**: [phases/phase_4_summary.md](phases/phase_4_summary.md)

### ⏳ Фаза 5: Прелоадер и блокировка рендера на время применения heightmap
- Добавить флаг в стор сцены, например `isTerrainApplying:boolean` и экшены `start/finish`.
- В `LandscapeLayer` при источнике `heightmap`:
  - до загрузки данных высот выставлять `start`; при `onHeightmapLoaded`/получении `heights` — `finish`;
  - пересоздание геометрии оставить как есть, но убрать лишние `console.log` в продакшене.
- В `Scene3D` подключить `LoadingOverlay` к флагу `isTerrainApplying` для блокировки и визуальной индикации.

### ⏳ Фаза 6: Документация и проверки
- Обновить документацию:
  - `docs/api/types/terrain.md` — указать про `heightmap` и хранение `heights`;
  - `docs/features/scene-management/terrain-system.md` — описать импорт, масштабирование и выбор из коллекции;
  - `docs/api/stores/scene-store.md` — новый флаг прелоадера.
- Добавить unit-тесты для утилиты извлечения высот и bilinear по массиву.
- Минимальная регрессия: ручная проверка сценариев импорта, выбора из коллекции, применения на сцене.
