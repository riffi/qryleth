---
id: 18
phase: 3
title: "Фаза 3: GfxHeightSampler — приоритет массива высот и билинейная интерполяция"
status: done
created: 2025-08-22
updated: 2025-08-22
filesChanged: 1
notes:
  - sampler: heights-путь с билинейной интерполяцией, кэши, fallback ImageData
---

# Фаза 3: GfxHeightSampler — выбор источника на основе массива высот

## Что сделано
- Добавлен приоритет семплинга из сохранённого массива высот (`Float32Array`) над `ImageData`:
  - реализовано числовое поле высот в `GfxHeightSampler` с глобальными кэшами `HEIGHTS_FIELD_CACHE` и `HEIGHTS_FIELD_LOAD_PROMISES`;
  - при наличии высот семплинг выполняется по ним; при отсутствии — сохраняется fallback по `ImageData`.
- Вынесена билинейная интерполяция по числовому массиву в отдельный метод `sampleHeightsFieldBilinear` с подробным комментарием:
  - принимает дробные координаты в «пиксельном» пространстве решётки и параметры нормализации;
  - возвращает интерполированную высоту в диапазоне `[min..max]`.
- Реализована загрузка высот из Dexie с «ленивой миграцией» (`loadHeightsFieldIfNeeded`):
  - при успешной загрузке/миграции сбрасывается локальный кэш `heightCache` и вызывается `onHeightmapLoaded()` для перегенерации геометрии;
  - предотвращено дублирование запросов за счёт реестра промисов.

## Изменённые файлы
- `apps/qryleth-front/src/features/scene/lib/terrain/GfxHeightSampler.ts`

## Результат
- При наличии предварительно рассчитанных высот из Dexie семплинг рельефа работает быстрее и предсказуемее (без обратной конвертации из пикселей).
- Сохранена обратная совместимость: до появления высот продолжается использование `ImageData` без регрессий.
- Геометрия слоя корректно пересоздаётся после завершения ленивой миграции на высоты.

## Критерии успешности
- [x] Предпочтение `heights` над `ImageData` в GfxHeightSampler.
- [x] Билинейная интерполяция по числовому массиву оформлена отдельным методом с комментарием.
- [x] Очистка локальных кэшей и вызов `onHeightmapLoaded` при появлении `heights`.

