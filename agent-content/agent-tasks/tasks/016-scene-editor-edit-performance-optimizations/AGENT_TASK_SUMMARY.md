---
id: 16
epic: 7
title: "Оптимизация производительности режима редактирования SceneEditor (Edit)"
status: planned
created: 2025-08-21
updated: 2025-08-21
owner: team-ui
tags: [scene-editor, performance, optimization, react, zustand, r3f, mantine]
phases:
  total: 6
  completed: 0
---

# Оптимизация производительности режима редактирования SceneEditor (Edit)

## Контекст
В режиме Play наблюдается более высокая производительность (FPS), чем в режиме Edit. Первичный анализ показал, что в Play не монтируются тяжёлые панели (левая: `SceneChatInterface`/`ScriptingPanel`, правая: `SceneObjectManager`), скрыт `ObjectTransformGizmo`, и отсутствуют частые перерендеры хедера и HUD. В Edit множество подписок на Zustand и операции со списками/редактором вызывают лишние коммиты React и подъём ререндеров до корневого контейнера `SceneEditorR3F`.

Основные источники нагрузки в Edit:
- Большая ширина подписки верхнего контейнера (`SceneEditorR3F`) на состояние стора: `objects`, `objectInstances`, `sceneMetaData`, `gridVisible`, `viewMode/renderMode/transformMode` и т.д.
- Левая панель: `SceneChatInterface` (чаты, табы, селекты моделей) и особенно `ScriptingPanel` (редактор/CodeMirror) — тяжёлые в смонтированном состоянии.
- Правая панель: `SceneObjectManager` делает агрегации и рендерит списки; при изменениях инстансов/слоёв/выделений перерисовывается значительная часть дерева.
- Хедер/правый блок действий зависят от undo/redo (`useSceneHistory`), что часто меняется.

Цель задачи — приблизить производительность Edit к Play за счёт уменьшения количества ненужных ререндеров, ленивого монтирования тяжёлых панелей и более узких селекторов Zustand.

## Список фаз

### ⏳ Фаза 1: Профилирование и метрики (базовая линия)
- Включить React Profiler и зафиксировать baseline для Edit/Play на одинаковой сцене: количество коммитов, среднее время коммита, узкие места.
- Добавить опциональный FPS‑оверлей (например, `stats.js`) на канву для локальных замеров (выключаем по флагу env/dev).
- Проставить временные счётчики ререндеров на ключевых узлах (лог/метки), чтобы подтвердить «шумные» компоненты.
- Критерии: есть отчёт с числами; выбраны приоритетные цели оптимизации.

### ⏳ Фаза 2: Изоляция крупных участков в SceneEditorR3F
- Вынести подкомпоненты и мемоизировать:
  - `StatusBadge` (подписка только на `sceneMetaData.status`).
  - `HeaderActions` (подписки на `canUndo/canRedo`).
  - HUD‑блок слева сверху (Grid/Transform/Render) — отдельный компонент с локальными селекторами.
- Заменить широкие подписки на узкие селекторы Zustand с `shallow` там, где возможно.
- Критерии: число ререндеров `SceneEditorR3F` снижается на X%; без изменения поведения.

### ⏳ Фаза 3: Ленивые панели и условный монтаж
- `ScriptingPanel`: `React.lazy` + `Suspense`, монтировать только при `scriptingPanelVisible === true`; при скрытии — размонтировать.
- `SceneChatInterface`: по возможности тоже лениво; при сворачивании — размонтировать, а не скрывать.
- Убедиться, что состояние не теряется критично; при необходимости — локальная персистентность.
- Критерии: время до первого полезного кадра в Edit и общее количество коммитов уменьшаются.

### ⏳ Фаза 4: Оптимизация SceneObjectManager
- Виртуализировать списки (например, Virtuoso/Mantine) для объектов/инстансов.
- Разбить список на мемоизированные строки/узлы; передавать минимальные пропы.
- Использовать специализированные селекторы и производные данные (`useObjectInstanceCounts`) там, где нужны только агрегаты.
- Критерии: время рендера панели заметно сокращено на больших сценах; прокрутка плавная.

### ⏳ Фаза 5: Селекторы стора и история
- Сузить подписки на Zustand по всему UI: использовать селекторы с `shallow`, `useMemo` для производных.
- Пересмотреть дебаунс истории/статусов: убедиться, что обновления не дергают лишние участки UI.
- Критерии: уменьшить каскадные ререндеры без потери реактивности интерфейса.

### ⏳ Фаза 6: Документация и DoD
- Обновить `docs/features/scene-management/performance.md` (создать при отсутствии): описать подходы и приёмы оптимизации.
- Добавить раздел «Performance tips» в `docs/api/components/scene-editor.md`.
- Зафиксировать метрики до/после и выводы.

## Критерии приёмки (DoD)
- [ ] В Edit количество лишних ререндеров ключевых узлов снижено (согласно профилировщику), коммиты корневого контейнера уменьшены.
- [ ] Сценарий «открыть Edit и начать работать» не стал медленнее (TTI не вырос).
- [ ] Ленивые панели монтируются по требованию; в свёрнутом состоянии не грузят рендер.
- [ ] Панель объектов масштабируется на больших сценах (виртуализация, плавный скролл).
- [ ] Документация обновлена, метрики до/после зафиксированы.

## Примечания по реализации
- Соблюдать FSD: селекторы/типы в соответствующих слоях (`features/scene/model`, `shared/types/ui`).
- Комментарии на русском к каждому новому публичному методу/хуку/компоненту.
- Лимит изменений на фазу ≤ 15 файлов; при необходимости дробить.
