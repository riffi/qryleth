# Анализ проблемы бесконечного цикла рендеринга

## Проблема
При открытии ObjectEditor возникает ошибка:
```
Maximum update depth exceeded. This can happen when a component repeatedly calls setState inside componentWillUpdate or componentDidUpdate. React limits the number of nested updates to prevent infinite loops.
```

## Предпринятые меры по устранению

### 1. Мемоизация компонентов
- ✅ Добавлен `React.memo` для `GroupTreeNodeComponent`
- ✅ Добавлен `React.memo` для `GroupTree`
- ✅ Добавлен `React.memo` для `PrimitiveItem`

### 2. Мемоизация обработчиков
- ✅ Добавлены `useCallback` для всех group management handlers
- ✅ Добавлены `useCallback` для всех drag-and-drop handlers
- ✅ Добавлен `useCallback` для `renderPrimitive`

### 3. Мемоизация вычислений
- ✅ Добавлен `useMemo` для подсчета примитивов в GroupTree
- ✅ Добавлены `useMemo` для `primitivesCount`, `selectedPrimitivesCount`, `selectedGroupsCount`

### 4. Оптимизация зависимостей
- ✅ Заменены массивы на их длину в зависимостях useCallback
- ✅ Убраны неиспользуемые импорты

### 5. Пошаговое отключение функциональности
- ✅ Отключен drag-and-drop - **проблема осталась**
- ✅ Отключен GroupTree полностью - **тестируется**

## Возможные причины

### 1. Проблема в GroupTree
- Рекурсивный компонент может создавать циклические обновления
- Неправильная мемоизация `getTotalPrimitiveCount`
- Проблемы с ключами в мапе групп

### 2. Проблема в PrimitiveItem
- Проблемы с мемоизацией
- Неправильные зависимости в useCallback

### 3. Проблема в store hooks
- Возможно, hook вызывает обновления, которые приводят к циклу
- Проблемы с селекторами zustand

### 4. Проблема в оригинальном коде
- Возможно, изменения в PrimitiveManager нарушили существующую логику
- Проблемы с обработчиками, которые вызывают setState в цикле

## Следующие шаги

### Если отключение GroupTree решает проблему:
1. Проблема в GroupTree компоненте или связанной логике
2. Нужно пошагово включать части GroupTree для локализации проблемы
3. Проверить рекурсивную логику в GroupTreeNodeComponent

### Если проблема остается:
1. Проблема в базовой логике PrimitiveManager или PrimitiveItem
2. Нужно проверить все новые обработчики и hooks
3. Возможно, откатиться к более простой версии

## Временное решение
Пока проблема решается, можно использовать упрощенную версию:
- Отключены GroupTree и drag-and-drop
- Отображается простой список всех примитивов
- Сохранена базовая функциональность (выделение, удаление, видимость)

## Результат отладки
✅ **ПРОБЛЕМА РЕШЕНА** - найдена причина бесконечного цикла

### Причина проблемы:
Бесконечный цикл был вызван комбинацией следующих факторов:
1. **Новые zustand hooks** - некоторые из новых селекторов (useObjectPrimitiveGroups, useGroupTree, etc.) могли создавать циклические обновления
2. **Сложные useCallback зависимости** - мемоизированные обработчики с массивами и объектами в зависимостях
3. **Состояние drag-and-drop** - локальные состояния для перетаскивания могли вызывать лишние рендеры

### Рабочее решение:
Упрощенная версия PrimitiveManager работает корректно с:
- ✅ Базовые hooks: useObjectPrimitives, useObjectSelectedPrimitiveIds, useObjectHoveredPrimitiveId
- ✅ Базовые actions: selectPrimitive, togglePrimitiveSelection, togglePrimitiveVisibility, removePrimitive
- ✅ Оригинальные обработчики без мемоизации
- ✅ Простое отображение примитивов без групп

## Статус
✅ **РЕШЕНО** - PrimitiveManager работает без бесконечного цикла

## План восстановления функциональности
1. **Поэтапное добавление** новых hooks и проверка после каждого шага
2. **Упрощение GroupTree** - убрать сложную мемоизацию, использовать более простые подходы
3. **Переработка drag-and-drop** - более простая реализация без множественных состояний
4. **Тестирование** каждого компонента отдельно

## Результаты поэтапного восстановления

### ✅ Step 1: useObjectPrimitiveGroups
- **Статус**: Работает без проблем
- **Результат**: Группы отображаются, подсчет групп работает

### ✅ Step 2: createGroup action
- **Статус**: Работает без проблем  
- **Результат**: Кнопка создания групп функционирует

### ✅ Step 3: Отображение групп
- **Статус**: Работает без проблем
- **Результат**: Группы отображаются как желтые блоки

### ✅ Step 4: deleteGroup action и контекстное меню
- **Статус**: Работает без проблем
- **Результат**: Удаление групп через контекстное меню работает

### ✅ Step 5: usePrimitiveGroupAssignments и assign/remove actions
- **Статус**: Работает без проблем
- **Результат**: Назначение примитивов в группы работает, отображаются индикаторы принадлежности

### ❌ Step 6: useUngroupedPrimitives  
- **Статус**: ВЫЗЫВАЕТ БЕСКОНЕЧНЫЙ ЦИКЛ
- **Проблема**: Добавление `useUngroupedPrimitives()` немедленно вызывает Maximum update depth exceeded
- **Решение**: Заменен на простое вычисление через filter без использования хука

## Выводы о проблемных hooks

### Безопасные hooks:
- ✅ `useObjectPrimitiveGroups()` 
- ✅ `usePrimitiveGroupAssignments()`

### Проблемные hooks:
- ❌ `useUngroupedPrimitives()` - вызывает бесконечный цикл
- ❓ `useGroupTree()` - не тестировался (предположительно проблемный)
- ❓ `useSelectedGroupUuids()` - не тестировался

### Рекомендации:
1. Избегать сложных селекторов zustand, которые выполняют фильтрацию
2. Использовать простые селекторы и выполнять вычисления в компоненте
3. Проверять каждый новый hook по отдельности перед интеграцией