---
id: 3
phase: 6
title: "Фаза 6: Обновление objectEditorApi и tools"
status: done
created: 2025-08-07
updated: 2025-08-08
---
# Фаза 6: Обновление objectEditorApi и tools

**Статус**: ✅ Выполнено

## Описание

Расширен API объект-редактора для поддержки операций с группами и обновлены AI tools для работы с иерархическими группами примитивов. Теперь AI может получать информацию о группах и создавать примитивы с автоматическим группированием.

## Выполненные действия

### 1. Обновление objectEditorApi

**Файл**: `src/features/object-editor/lib/objectEditorApi.ts`

#### Расширение getObjectData()
- **Добавлен вывод групп**: метод теперь включает `primitiveGroups` и `primitiveGroupAssignments` в возвращаемый объект
- **Полная информация о структуре**: AI tools теперь получают полную картину иерархии групп при запросе данных объекта
- **Обратная совместимость**: существующие вызовы продолжают работать без изменений

#### Расширение addPrimitives()
- **Поддержка создания групп**: добавлены опциональные параметры `groupName` и `parentGroupUuid`
- **Автоматическая привязка**: при указании `groupName` создается группа и все добавляемые примитивы автоматически привязываются к ней
- **Иерархическое группирование**: поддержка создания подгрупп через `parentGroupUuid`
- **Расширенный возврат**: метод теперь возвращает как количество добавленных примитивов, так и UUID созданной группы

**Сигнатура метода**:
```typescript
static addPrimitives(
  primitives: GfxPrimitive[], 
  groupName?: string, 
  parentGroupUuid?: string
): { addedCount: number; groupUuid?: string }
```

### 2. Обновление AI Tools

#### getObjectDataTool
- **Автоматическая поддержка групп**: tool автоматически получил поддержку групп через обновленный API метод
- **Без изменений кода**: требовались только изменения в базовом API методе

#### addPrimitivesTool

**Файл**: `src/features/object-editor/lib/ai/tools/primitiveTools.ts`

**Расширения**:
- **Новые параметры схемы**:
  - `groupName`: опциональное имя группы для создания
  - `parentGroupUuid`: опциональный UUID родительской группы для создания подгруппы
- **Обновленное описание**: tool теперь информирует о возможности создания групп
- **Расширенный результат**: возвращает информацию о созданной группе

**Новая схема**:
```typescript
schema: z.object({
  primitives: z.array(PrimitiveSchema).min(1).max(10),
  groupName: z.string().min(1).optional().describe('Имя группы для создания и привязки добавляемых примитивов'),
  parentGroupUuid: z.string().optional().describe('UUID родительской группы для создания подгруппы')
})
```

**Новый результат**:
```json
{
  "success": true,
  "addedCount": 3,
  "groupUuid": "uuid-of-created-group",
  "groupCreated": true
}
```

## Ключевые архитектурные решения

### Обратная совместимость
- Все существующие вызовы API продолжают работать без изменений
- Новые параметры являются опциональными
- Старый формат возврата поддерживается через деструктуризацию

### Интеграция с objectStore
- Использование существующих методов `createGroup` и `assignPrimitiveToGroup`
- Правильная привязка примитивов к группам через UUID
- Поддержка иерархической структуры через `parentGroupUuid`

### AI-friendly дизайн
- Понятные имена параметров и описания для AI
- Четкая структура результатов с булевыми флагами
- Поддержка как простого, так и группированного создания примитивов

## Критерии успешности

✅ **API включает информацию о группах в getObjectData()**
- `primitiveGroups` и `primitiveGroupAssignments` корректно возвращаются
- AI tools получают полную информацию о структуре групп

✅ **addPrimitives поддерживает создание групп**
- Опциональные параметры `groupName` и `parentGroupUuid` работают корректно
- Создание групп и привязка примитивов происходит автоматически
- Возвращается UUID созданной группы

✅ **getObjectDataTool автоматически поддерживает группы**
- Без изменений в коде tool получил полную поддержку групп
- AI может анализировать иерархическую структуру объектов

✅ **addPrimitivesTool поддерживает создание групп**
- Новые параметры корректно валидируются через Zod схему
- AI может создавать группированные примитивы одной командой
- Результат содержит полную информацию о выполненной операции

✅ **Сохранена обратная совместимость**
- Существующие вызовы продолжают работать
- Старые AI tools функционируют без изменений
- Новая функциональность полностью опциональна

## Интеграция с существующей системой

Все изменения полностью интегрированы с существующими компонентами:
- **objectStore**: Используются существующие методы управления группами
- **Существующие tools**: Продолжают работать без изменений
- **API интерфейсы**: Расширены только опциональными полями
- **Типизация**: Сохранена строгая типизация всех новых методов

## Примеры использования AI

### Создание простых примитивов (как раньше)
```json
{
  "primitives": [
    {"type": "box", "geometry": {"width": 2, "height": 2, "depth": 2}},
    {"type": "sphere", "geometry": {"radius": 1}}
  ]
}
```

### Создание примитивов с группой
```json
{
  "primitives": [
    {"type": "box", "geometry": {"width": 2, "height": 2, "depth": 2}},
    {"type": "sphere", "geometry": {"radius": 1}}
  ],
  "groupName": "Геометрические фигуры"
}
```

### Создание подгруппы
```json
{
  "primitives": [
    {"type": "cylinder", "geometry": {"radiusTop": 1, "radiusBottom": 1, "height": 2}}
  ],
  "groupName": "Колонны",
  "parentGroupUuid": "uuid-of-building-group"
}
```

## Следующие шаги

Фаза 6 успешно завершена. ObjectEditor API и tools теперь полностью поддерживают работу с группами примитивов. AI может получать информацию о группах и создавать структурированные объекты. Готов к переходу к фазе 7 (расширение tools для sceneEditor).