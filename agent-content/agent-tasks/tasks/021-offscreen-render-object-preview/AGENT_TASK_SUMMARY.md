---
id: 21
epic: null
title: "Реализация offscreen render превью объектов в библиотеке при сохранении"
status: in-progress
created: 2025-08-26
updated: 2025-08-26
owner: team-ui
tags: [frontend, r3f, preview, offscreen-render]
phases:
  total: 4
  completed: 3
---

# Реализация offscreen render превью объектов в библиотеке при сохранении

## Обязательная информация
!Правила работы с агентскими задачами: [agent-tasks.md](../../../../docs/development/workflows/agent-tasks.md)
**ВАЖНО**: При выполнении каждой из фаз необходимо обязательно сверяться с требованиями и принципами из указанного файла.

## Цели
- Автоматическое генерирование превью изображений для 3D объектов при сохранении в библиотеку
- Интеграция offscreen рендеринга с существующей системой сохранения объектов
- Улучшение пользовательского опыта при просмотре библиотеки объектов

## Контекст
В текущей реализации система сохранения объектов в библиотеку уже поддерживает поле `thumbnail` в `ObjectRecord` и `SaveObjectDialog`, но превью не генерируется автоматически. Пользователи видят объекты в библиотеке без визуального представления, что затрудняет быстрый поиск и выбор нужного объекта.

Проект использует React Three Fiber для 3D рендеринга, IndexedDB через Dexie для хранения данных, и имеет хорошо структурированную архитектуру с разделением на слои (entities, features, shared).

Существующая инфраструктура:
- `ObjectEditorR3F` и `ObjectScene3D` для рендеринга объектов
- `SceneLibraryDB.saveObject()` с поддержкой thumbnail
- `SaveObjectDialog` с интерфейсом для ввода метаданных
- `buildUpdatedObject()` для формирования итогового объекта

## Список фаз

### ✅ Фаза 1: Создание утилиты offscreen рендеринга
- Создание `features/object-editor/lib/offscreen-renderer/OffscreenObjectRenderer.ts`
- Реализация класса для offscreen рендеринга 3D объектов с использованием Three.js WebGLRenderer
- Параметры превью: 256x256 PNG с прозрачным фоном
- Стандартное освещение для консистентного вида превью
- Автоматический выбор оптимального ракурса через анализ bounding box объекта
- Оптимизация для быстрого рендеринга (упрощенные материалы, отключение теней)

**Отчёт**: [phases/phase_1_summary.md](phases/phase_1_summary.md)

### ✅ Фаза 2: Интеграция с процессом сохранения объектов
- Модификация `saveUtils.ts` для генерации превью перед сохранением (только при сохранении)
- Обновление `SaveObjectDialog` для отображения прогресса генерации превью
- Сохранение thumbnail как base64 data URL в `ObjectRecord` для максимальной скорости чтения
- Добавление fallback-логики при ошибках рендеринга
- Кэширование сгенерированного превью в памяти для повторного использования

**Отчёт**: [phases/phase_2_summary.md](phases/phase_2_summary.md)

### ✅ Фаза 3: Отображение превью в интерфейсе библиотеки  
- Создание компонента `ObjectPreviewCard` с оптимизированным рендерингом base64 изображений
- Обновление существующих компонентов библиотеки для использования превью
- Реализация виртуализации для отображения десятков превью без снижения производительности
- Добавление placeholder'ов для объектов без превью (fallback изображение)
- Кэширование декодированных изображений в браузере для повторного использования

**Отчёт**: [phases/phase_3_summary.md](phases/phase_3_summary.md)

### ⏳ Фаза 4: Обновление документации и тестирование
- Обновление документации в `docs/` с описанием системы превью
- Создание примеров использования и настройки
- Добавление unit тестов для `OffscreenObjectRenderer`
- Интеграционное тестирование процесса сохранения с превью
- Обновление `README.md` и других релевантных документов