---
title: "Фаза 6 — Кэши и инвалидация ассетов"
status: completed
date: 2025-08-26
---

# Фаза 6 — Кэши и инвалидация ассетов

Цель фазы — ввести контролируемые (soft) кэши для PNG heightmap данных с защитой от утечек памяти и предусмотреть явную инвалидацию при изменении ассетов. Реализованы TTL/LRU‑механизмы для кэша `ImageData` и числового поля высот, добавлена глобальная очистка кэшей, а также вызовы инвалидации при удалении/переименовании ассета.

## Сделанные изменения

- `apps/qryleth-front/src/features/scene/lib/terrain/assets/heightmapCache.ts`:
  - Добавлены LRU/TTL кэши для двух типов данных:
    - `ImageData` (TTL: ~5 минут простоя, максимум 32 элемента),
    - `HeightsField` (TTL: ~10 минут простоя, максимум 64 элемента).
  - Методы:
    - `getCachedImageData` / `setCachedImageData` — с обновлением `lastAccess`, очисткой просроченных записей и выселением LRU.
    - `getCachedHeightsField` / `setCachedHeightsField` — аналогично.
    - `invalidate(assetId)` — удаление данных и активных загрузок по конкретному ассету.
    - `clear()` — полная очистка всех кэшей и реестров промисов загрузки.
  - Загрузчики `loadImageData` / `loadHeightsField` переведены на `get*/set*` API кэша.

- `apps/qryleth-front/src/features/scene/lib/terrain/HeightmapUtils.ts`:
  - `deleteTerrainAsset(assetId)` — после удаления записи в Dexie вызывает инвалидацию кэшей через динамический импорт `heightmapCache` (избежание циклической зависимости).
  - `renameTerrainAsset(assetId, newFileName)` — после переименования также вызывает инвалидацию кэшей для консистентности отображения.

## Результаты

- Память под кэшами высот и изображений контролируется: при простое записи очищаются по TTL, при превышении лимитов — выселяются наименее используемые.
- При удалении или переименовании ассетов кэши сбрасываются, что предотвращает использование устаревших данных и обеспечивает консистентность.

## Затронутые файлы

- Изменены: `heightmapCache.ts`, `HeightmapUtils.ts`.

## Примечания

- Значения TTL и лимитов выбраны консервативно и при необходимости могут быть вынесены в конфиг террейна в рамках последующих итераций.

