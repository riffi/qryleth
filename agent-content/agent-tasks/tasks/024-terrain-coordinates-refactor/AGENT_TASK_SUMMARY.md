---
id: 24
epic: null
title: "Рефакторинг координатной системы террейна"
status: in_progress
created: 2025-08-27
updated: 2025-08-27
owner: team-ui
tags: [refactoring, types, coordinates, terrain, documentation, breaking-change]
phases:
  total: 6
  completed: 3
---

# Рефакторинг координатной системы террейна

## Обязательная информация
!Правила работы с агентскими задачами: [agent-tasks.md](../../../../docs/development/workflows/agent-tasks.md)
**ВАЖНО**: При выполнении каждой из фаз необходимо обязательно сверяться с требованиями и принципами из указанного файла.

## Цели
Переименование параметров координатной системы террейна для устранения путаницы между вертикальной высотой и глубиной по оси Z, а также исправление всех примеров и документации для правильного размещения объектов относительно центра мира.

## Контекст
**Проблема**: Текущие названия полей сбивают с толку разработчиков:
- `world.height` означает размер по оси Z (глубина), а не по оси Y (высота)
- `area.height` в прямоугольной области также означает размер по Z, что противоречит интуиции
- Примеры в scriptingPanel используют неправильные координаты, размещая объекты за пределами видимой области мира

**Координатная система террейна**:
- Мир имеет центр в [0, 0, 0]
- При размерах world: `{width: 300, height: 200}` реальные пределы: X [-150, +150], Z [-100, +100]
- Y - вертикальная ось (высота террейна над/под уровнем)
- Z - ось глубины (ближе-дальше от наблюдателя)

**Технические последствия**:
- Пользователи задают координаты типа `z: 160` для области размещения, но пределы мира только [-100, +100]
- Объекты генерируются вне видимой области и не отображаются
- Документация не объясняет принцип центрирования координат

## Список фаз

### ✅ Фаза 1: Рефакторинг типов с обратной совместимостью
- Переименовать `world.height` → `world.depth` в `GfxProceduralTerrainSpec`
- Переименовать `area.height` → `area.depth` в `GfxPlacementArea`
- Добавить deprecated поля `height` с маркировкой `@deprecated`
- Обновить комментарии для ясности координатной системы
- Добавить JSDoc с примерами правильных координат

Выполнено:
- Обновлены типы: `apps/qryleth-front/src/entities/terrain/model/proceduralTypes.ts` (добавлено поле `world.depth`, `area.rect.depth`, помечены `height` как `@deprecated`).
- Добавлены подробные JSDoc с описанием осей, центра мира и диапазонов координат.
- Сохранена обратная совместимость: поддержка `height` оставлена на переходный период.

### ✅ Фаза 2: Обновление кода обработки
- Обновить `ProceduralTerrainGenerator.ts` для поддержки новых полей
- Модифицировать функции размещения `PlacementUtils.ts` и `PlacementAlgorithms.ts`
- Заменить все использования `worldHeight` → `worldDepth` в коде
- Добавить fallback логику для deprecated полей
- Обеспечить работу тестов с новой логикой

Выполнено:
- `ProceduralTerrainGenerator.ts` принимает `worldDepth` (с fallback на `worldHeight`), читает `spec.world.depth ?? spec.world.height`, прокидывает глубину в генерацию и сохраняет совместимость с `GfxTerrainConfig` (используется поле `worldHeight` как «глубина Z»).
- `PlacementAlgorithms.ts`: обновлены сигнатуры и внутренняя логика всех алгоритмов (`uniform`, `poisson`, `gridJitter`, `ring`) — используется `worldDepth ?? worldHeight`.
- `PlacementUtils.ts`: функции построения/проверки границ теперь работают с глубиной Z; для прямоугольной области учитывается `area.depth ?? area.height`.
- Добавлены и уточнены JSDoc‑комментарии по терминологии (глубина Z) и fallback.

Примечания:
- Обратная совместимость сохранена: существующие вызовы с `worldHeight` и `area.height` продолжают работать.
- Глобальное переименование поля `worldHeight` в `GfxTerrainConfig` не выполнялось (вне текущего scope). Миграция примеров и документации — в следующих фазах.

### ✅ Фаза 3: Исправление примеров в scriptingPanel
- Найти все файлы с примерами процедурной генерации террейна
- Исправить координаты областей размещения (относительно центра мира)
- Заменить `height` на `depth` во всех примерах
- Добавить комментарии с объяснением координатной системы
- Создать набор готовых шаблонов для разных сценариев размещения

Выполнено:
- Обновлены шаблоны ScriptingPanel: `apps/qryleth-front/src/features/scene/ui/ScriptingPanel/constants/scriptTemplates.ts`
  - В `world` заменено `height` → `depth` с пояснениями про центр мира и ось Z.
  - Для `area.rect` заменено `height` → `depth` и исправлены координаты зон на центрированные (X [-W/2..+W/2], Z [-D/2..+D/2]).
  - Неверные примеры `placement: { type: 'uniform', center: [...] }` заменены на корректные `ring` с `center` и малыми радиусами для «центрального» размещения.
  - Исправлены выходящие за пределы мира координаты (например, север/юг/побережье/архипелаг).
- Обновлены подсказки автодополнения:
  - `apps/qryleth-front/src/features/scene/ui/ScriptingPanel/constants/completionData.ts` — примеры и описание `world` теперь с `depth`; опции `generateTerrainOpsFromPool` используют `worldDepth`.
  - `apps/qryleth-front/src/features/scene/ui/ScriptingPanel/hooks/useAIScriptGenerator.ts` — примеры в системном промпте и сниппетах обновлены на `depth` и центрированные координаты.
- Обновлена документация примеров ScriptingPanel:
  - `docs/features/scene-management/terrain-in-scripting-panel.md` — примеры `world.depth`, корректные зоны `area.depth`, центрированные координаты и комментарии.
  - Точечные правки примеров в `docs/api/scene-api.md` и `docs/api/types/terrain.md` (только специфика процедурной генерации) — замена `height` → `depth` в `world`.

Примечания:
- Базовая модель `GfxTerrainConfig` по‑прежнему использует `worldWidth/worldHeight` (задокументировано как «глубина Z»), её миграция вне текущей фазы.

### ⏳ Фаза 4: Создание новых тестов и валидация
- Создать comprehensive тесты для проверки правильности координат
- Протестировать размещение в разных частях мира (север/центр/юг)
- Добавить тесты для проверки обратной совместимости
- Убедиться что визуализация работает корректно во всех случаях
- Добавить валидацию координат с понятными сообщениями об ошибках

### ⏳ Фаза 5: Обновление документации
- Создать диаграмму координатной системы террейна с примерами
- Написать миграционную документацию для существующего кода
- Обновить README с подробным объяснением координатной системы
- Добавить секцию "Частые ошибки" с примерами решений
- Обновить комментарии в коде с актуальными примерами

### ⏳ Фаза 6: Обновить основную проектную документацию docs
- Обновить документацию по системе террейна
- Добавить гид по миграции в docs/
- Обновить архитектурные документы при необходимости
- Проверить актуальность всех ссылок и примеров
