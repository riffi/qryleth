---
task_id: 5
phase: 6
title: Сохранение изменений в файлы
status: done
created: 2025-08-19
updated: 2025-08-19
---

# Фаза 6: Сохранение изменений в файлы

## Статус
✅ **Выполнено**

## Цели фазы
- Реализация Backend API для обновления задач: PUT /api/tasks/:id
- Сохранение изменений обратно в markdown файлы с корректной YAML шапкой
- Валидация формата и структуры данных перед сохранением
- Интеграция с frontend формой редактирования

## Выполненная работа

### 1. Backend API для обновления задач
- **Файл**: `apps/agent-tasks-ui/backend/src/routes/tasks.ts`
- **Добавлен endpoint**: `PUT /api/tasks/:id`
- **Функциональность**:
  - Принимает JSON с полями: `title`, `tags`, `content`
  - Валидация входных данных (длина названия, формат тегов, размер контента)
  - Поиск задачи по ID как в обычных задачах, так и в задачах эпиков
  - Обновление файла с сохранением существующих метаданных

### 2. Функция обновления задач в файловой системе
- **Файл**: `apps/agent-tasks-ui/backend/src/services/fileSystemService.ts`
- **Добавлена функция**: `updateTaskById(id, updates)`
- **Особенности реализации**:
  - Автоматический поиск файла задачи в структуре папок
  - Парсинг существующих YAML метаданных
  - Обновление полей `title`, `tags`, `updated` с сохранением остальных
  - Правильное форматирование YAML шапки (массивы, объекты phases)
  - Сохранение файла с корректной кодировкой UTF-8

### 3. Интеграция с Frontend
- **Файл**: `apps/agent-tasks-ui/frontend/src/pages/TaskDetailPage.tsx`
- **Реализованные возможности**:
  - Форма редактирования с валидацией полей
  - Monaco Editor для редактирования Markdown контента
  - Автоматическое создание YAML шапки при сохранении
  - Обработка ошибок валидации и сохранения
  - Уведомления об успешном сохранении/ошибках
  - Кнопки "Сохранить"/"Отменить" с состояниями загрузки

### 4. Валидация данных
- **Frontend валидация** (useForm):
  - Название: от 3 до 200 символов
  - Теги: максимум 10 тегов, каждый до 50 символов, буквы/цифры/дефисы
  - Контент: от 10 до 50000 символов
- **Backend валидация** (API endpoint):
  - Проверка типов данных
  - Валидация обязательных полей
  - Проверка существования задачи перед обновлением

## Технические решения

### Обработка YAML метаданных
- Используется библиотека `gray-matter` для парсинга/генерации
- Сохранение существующих полей (`id`, `epic`, `status`, `created`, `phases`)
- Автоматическое обновление поля `updated` текущей датой
- Правильное форматирование массивов и объектов в YAML

### Работа с контентом
- Разделение YAML шапки и Markdown контента
- Frontend отображает только контент без шапки в редакторе
- Автоматическое создание полной структуры файла при сохранении
- Обработка специальных символов в YAML значениях

### API интеграция
- **Frontend**: `updateTask(id, data)` функция в `apiService`
- **Backend**: валидация, обновление файла, возврат обновленной задачи
- Правильная обработка ошибок на всех уровнях

## Результат
Фаза 6 полностью завершена. Пользователи теперь могут:
- Редактировать название, теги и содержимое задач через веб-интерфейс
- Сохранять изменения в исходные markdown файлы
- Получать уведомления об успехе/ошибках операции
- Видеть валидационные сообщения при некорректных данных

Все изменения сохраняются с корректной YAML структурой и автоматически обновляют дату изменения задачи.