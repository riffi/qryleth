---
id: 14
epic: null
title: Упразднение useUISync и прямой стор‑синк в SceneEditor
status: planned
created: 2025-08-19
updated: 2025-08-19
owner: team-ui
tags: [scene-editor, refactor, r3f, state, ui, zustand]
phases:
  total: 6
  completed: 0
---

# Упразднение useUISync и прямой стор‑синк в SceneEditor

## Обязательная информация
!Правила работы с агентскими задачами: [agent-tasks.md](../../../../docs/development/workflows/agent-tasks.md)
**ВАЖНО**: При выполнении каждой из фаз необходимо обязательно сверяться с требованиями и принципами из указанного файла.

## Цели
- Перевести синхронизацию UI ↔ R3F для SceneEditor на прямое взаимодействие со стором (по аналогии с ObjectEditor)
- Удалить событийный мост `useUISync`/`useSceneUISync` и вызовы `CustomEvent` из приложения
- Снизить сложность, устранить зависимость от `window`, улучшить типобезопасность и отладку

## Контекст
В фиче SceneEditor синхронизация между UI и сценой реализована через событийный мост `window` (`useUISync`, `useSceneUISync`), который диспатчит/слушает события `ui:*` и `r3f:*`. В ObjectEditor используется прямой доступ к Zustand‑стору, что проще, надёжнее и легче тестируется. Требуется унифицировать подход: перевести SceneEditor на прямой стор‑синк и убрать событийный слой.

## Список фаз

### ⏳ Фаза 1: Инвентаризация и проектирование API стора
- Найти все использования `useUISync`, `useSceneUISync`, а также прямые диспатчи/слушатели `CustomEvent` (`ui:*`, `r3f:*`)
- Составить карту зависимостей: какие данные и события реально нужны (выбор, ховер, состав объектов/экземпляров, модификации сцены, realtime)
- Сверить текущий API `useSceneStore` и определить недостающие селекторы/экшены
- Согласовать целевой контракт стора (селекторы, экшены, типы)

Критерии:
- [ ] Сформирован список мест для правок с точными файлами/строками
- [ ] Определён и зафиксирован в описании задачи целевой API стора

### ⏳ Фаза 2: Прямой стор‑синк для SceneEditor (внедрение без удаления моста)
- Подключить UI‑компоненты SceneEditor напрямую к `useSceneStore` (селекторы/экшены) вместо прослушивания `r3f:*`
- Подключить R3F‑компоненты SceneEditor к стору вместо диспатча `r3f:*` (выбор, ховер, изменения данных сцены)
- Оставить `useSceneUISync` подключённым, но фактически неиспользуемым (фича должна работать целиком через стор)

Критерии:
- [ ] Все пользовательские сценарии работают без событийного слоя
- [ ] Нет регрессий в выборе/ховере/перерисовке/модификации сцены

### ⏳ Фаза 3: Миграция и удаление событийных вызовов
- Заменить диспатчи `CustomEvent('ui:*')` на прямые вызовы экшенов стора
- Удалить слушатели `r3f:*` из UI и R3F, заменить на селекторы стора
- Убедиться, что функционал `realTimeUpdate` покрыт подпиской на стор (или точечными селекторами)

Критерии:
- [ ] В кодовой базе отсутствуют обращения к `ui:*`/`r3f:*`
- [ ] Производительность не ухудшилась; нет утечек слушателей

### ⏳ Фаза 4: Деинсталляция `useUISync`/`useSceneUISync` и чистка импортов
- Удалить файлы `useUISync.ts`, `useSceneUISync.ts` и все их импорты
- Если необходим внешний фасад совместимости (для сторонних потребителей), создать минимальный адаптер поверх стора в отдельной фиче (без использования `window`)
- Очистить dead code, обновить баррели и индексы

Критерии:
- [ ] Файлы хуков удалены, сборка зелёная
- [ ] Импорты скорректированы, не осталось неиспользуемых экспортов

### ⏳ Фаза 5: Регресс‑тестирование и стабилизация
- Ручной чек‑лист: выбор/снятие выбора, ховер, добавление/удаление/изменение объектов и инстансов, маркировка «scene modified», изменение режимов отображения
- Проверка интеграции с трансформ‑гизмой и OrbitControls
- Базовые юнит‑тесты для стора (если есть инфраструктура), smoke‑прогон приложения

Критерии:
- [ ] Все сценарии из чек‑листа проходят
- [ ] Нет ошибок в консоли, отсутствие утечек/лишних слушателей

### ⏳ Фаза 6: Обновление документации проекта
- Обновить `docs/` (архитектура синхронизации сцен): убрать описание событийного моста, описать прямой стор‑подход, схемы данных и взаимодействия
- Обновить разделы, где упоминались `useUISync`/`useSceneUISync`, добавить миграционные заметки

Критерии:
- [ ] Документация содержит актуальные схемы и примеры кода
- [ ] Удалены упоминания устаревших хуков, добавлены рекомендации
