---
id: 15
epic: null
title: "Play-режим на странице редактора сцены (SceneEditorR3F)"
status: in-progress
created: 2025-08-21
updated: 2025-08-21
owner: team-ui
tags: [scene-editor, play-mode, ui, camera, hotkeys]
phases:
  total: 6
  completed: 4
---

# Play‑режим для SceneEditor (в той же странице)

## Контекст
AS‑IS:
- На странице редактора сцены уже реализованы режимы камеры: orbit / walk / fly через `viewMode` в zustand (`features/scene/model/sceneStore.ts`).
- Компонент переключения камер — `CameraControls` с `OrbitControls`, `WalkControls`, `FlyControls`.
- Глобального режима UI (edit/play) нет; хедер/навигация/панели всегда отображаются через `MainLayout` и панельные контейнеры в `SceneEditorR3F`.
- Хоткеи реализованы частично в `useKeyboardShortcuts` (трансформации, undo/redo, перемещения выбранного объекта), но нет глобальных хоткеев для play/edit и переключения камер.
- Рендера-профилей нет — есть только `renderMode: 'solid'|'wireframe'`.

Требование проекта: все перечисления оформлять строго как `enum` (а не строковые union-типы). В текущем коде имеются строковые типы для `ViewMode`, `RenderMode`, `TransformMode` (в `shared/types/ui`). В рамках задачи требуется ввести новые enum-ы и выполнить мягкую миграцию потребителей без больших диффов.

TO‑BE (по play_mode.md) с учётом текущего кода:
- Ввести глобальный UI‑режим страницы: `uiMode: 'edit' | 'play'` в сценовом store. В режиме `edit` доступен весь UI (хедер, панели, гизмо, хоткеи редактора), камера строго Orbit. В `play` — скрыть UI, разрешить камеры Orbit/Walk/Fly и хоткеи `Esc/P/1-3`.
- Добавить `renderProfile: 'edit' | 'view'` (отдельно от `renderMode`). На первом шаге только флаг без фактической разницы настроек.
- Кнопка Play в хедере редактора для мгновенного перехода. В `play` поверх канвы показывать компактную кнопку Exit (overlay) и подсказку при первом входе.
- Хоткеи: `P` — toggle play; `Esc` — выход из play; `1/2/3` — переключение камер в play.
- Сохранять позу камеры при переходах и переключении камер; в `edit` всегда Orbit.

Главные расхождения/учёт текущей реализации:
- Камеры уже есть — доработать только режимы и хоткеи, а также хранение позы камеры(позиция + цель для Orbit; позиция/ориентация для Walk/Fly).
- Для скрытия UI потребуется добавить пропсы или состояние в `MainLayout` (скрыть header/navbar) и в `SceneEditorR3F` (скрыть боковые панели). Это изменение ограничим локально страницей/лейаутом.

## Цели
- Реализовать единый глобальный Play‑режим на странице редактора сцены без смены роутов.
- Обеспечить бесшовное переключение (<50 мс) без пересоздания сцены и мерцаний.
- Сохранить обратную совместимость хоткеев и поведения в режиме редактирования.
- Перевести существующие строковые перечисления на `enum` с максимально безопасной миграцией и обратной совместимостью на этапе внедрения.

## Список фаз

### ✅ Фаза 1: Enum-перечисления и базовое состояние (uiMode/renderProfile/cameraPose)
- Добавить enum-типизацию в `shared/types/ui` и экспортировать:
  - `export enum UiMode { Edit = 'edit', Play = 'play' }`
  - `export enum RenderProfile { Edit = 'edit', View = 'view' }`
  - Подготовить enum-аналоги существующих строковых типов (без немедленной замены всех потребителей):
    - `export enum ViewModeEnum { Orbit = 'orbit', Walk = 'walk', Fly = 'fly' }`
    - `export enum RenderModeEnum { Solid = 'solid', Wireframe = 'wireframe' }`
    - `export enum TransformModeEnum { Translate = 'translate', Rotate = 'rotate', Scale = 'scale' }`
  - На время миграции оставить существующие тип-алиасы `type ViewMode = ...` и т.п., но новые API и новые поля стора использовать только enum-ы.
- Расширить `SceneStoreState` полями: `uiMode: UiMode` (default `UiMode.Edit`), `renderProfile: RenderProfile` (default `RenderProfile.Edit`).
- Добавить экшены стора:
  - `setUiMode(mode: UiMode)` — устанавливает глобальный режим UI. Комментарий: когда применять, какие побочные эффекты недопустимы.
  - `togglePlay()` — переключает `UiMode` между Edit/Play. Комментарий: не пересоздаёт сцену, только флаги.
  - `setRenderProfile(profile: RenderProfile)` — переключает профиль рендера.
- Подготовить хранение «позы камеры» в сторе: `cameraPose: { position: [x,y,z]; target?: [x,y,z]; rotation?: [x,y,z] }` и экшены `saveCameraPose(pose)`/`restoreCameraPose()`. На этой фазе — без связывания с UI.
- Обязательные подробные комментарии на русском у каждого нового метода/поля стора и рядом с enum-ами в типах.

Критерии:
- Сборка зелёная, стор компилируется, поведение edit‑режима прежнее.

**Отчёт**: [phases/phase_1_summary.md](phases/phase_1_summary.md)

### ✅ Фаза 2: UI переключение (Play ▶ / Exit ⏹) и скрытие
- Добавить в `MainLayout` управляемые пропсы для скрытия `header` и `navbar` (например, `headerVisible`, `navbarVisible`), по умолчанию true. Документировать в JSDoc на русском.
- В `SceneEditorR3F` добавить кнопку `Play ▶` в `rightSection` хедера при `uiMode='edit'` → вызывает `togglePlay()`.
- При `uiMode='play'`: скрыть хедер/навигацию (через новые пропсы лейаута), скрыть боковые панели, рендерить только канву + overlay с кнопкой `Exit ⏹` (фикс. в углу), по клику → `togglePlay()`.
- Анимация hide/show UI 200–250ms (CSS transition, без тяжёлых зависимостей).

Критерии:
- Нажатие Play скрывает UI, остаётся канва и кнопка Exit; обратное переключение — без мерцаний.

**Отчёт**: [phases/phase_2_summary.md](phases/phase_2_summary.md)

### ✅ Фаза 3: Хоткеи Play/Esc и переключение камер 1–3 (через enum)
- Добавить хук `usePlayModeHotkeys` (или расширить `useKeyboardShortcuts`) c учётом `uiMode`:
  - Глобально: `P` — toggle play; `Esc` — выход из play.
  - В `play`: разрешить только `Esc`, `P`, `1/2/3` → `setViewMode(ViewModeEnum.Orbit/Walk/Fly)`. Отключить хоткеи редактора в play.
  - Игнорировать нажатия во время ввода в поля/CodeMirror (как сейчас сделано) и во время drag’n’drop.
- Освободить pointer lock при выходе из play.

Критерии:
- В play работают 1/2/3 и P/Esc; в edit — прежние хоткеи, камеры переключаются только через UI.

**Отчёт**: [phases/phase_3_summary.md](phases/phase_3_summary.md)

### ✅ Фаза 4: Принудительный Orbit в edit и сохранение позы камеры (через enum)
- Ввести синхронизацию позы камеры: при входе/выходе из play сохранять/восстанавливать `cameraPose`.
- В режиме `UiMode.Edit` принудительно использовать Orbit: при входе в edit, если `viewMode !== ViewModeEnum.Orbit`, переключить на Orbit и восстановить `target`.
- При переключении камер в play сохранять текущую позу предыдущего режима.

Критерии:
- Поза камеры (позиция/цель) сохраняется между режимами/переключениями, edit всегда Orbit.

**Отчёт**: [phases/phase_4_summary.md](phases/phase_4_summary.md)

### ⏳ Фаза 5: RenderProfile флаг и прокидка в рендер (enum)
- Хранить `renderProfile` в сторе и переключать: `edit` в `uiMode='edit'`, `view` в `uiMode='play'`.
- Прокинуть профиль в `Scene3D`/`SceneContent` (пока без реальных отличий настроек; подготовка на будущее, важен флаг).

Критерии:
- `renderProfile` корректно переключается вместе с `uiMode` (видимых отличий может не быть).

### ⏳ Фаза 6: Документация и DoD + безопасная миграция типов на enum
- Обновить документацию:
  - `docs/features/scene-management/keyboard-shortcuts.md` — добавить новые хоткеи (`P`, `Esc`, `1–3`).
  - `docs/api/components/scene-editor.md` — отразить поведение Play/Exit и новые пропсы `MainLayout`.
  - `docs/architecture/design-principles.md` — упомянуть `renderProfile` как абстракцию.
- Запланировать и описать отдельную малую миграцию потребителей на enum-ы (если не уложилось в текущие фазы), с пошаговой заменой `type ViewMode = ...` → `ViewModeEnum` и т.д. с ограничением ≤ 15 файлов на фазу.
- Сверить реализацию с `play_mode.md` и отметить соответствие критериям приёмки.

Критерии:
- Все критические пути описаны, документация обновлена и согласована с реализацией.

## Критерии приёмки (DoD)
- [ ] В `edit` доступны панели/хедер/гизмос/хоткеи редактора; камера — Orbit.
- [ ] Кнопка Play скрывает UI, остаётся канва; камера Orbit; поза сохраняется.
- [ ] Esc/P в play возвращают в edit без мерцаний и пересоздания сцены.
- [ ] В play переключение камер 1/2/3 (Orbit/Walk/Fly) работает.
- [ ] В play хоткеи редактора отключены (кроме Esc/P/1–3).
- [ ] Переключение режимов не пересоздаёт сцену/объекты, FPS стабильный.
- [ ] `renderProfile` переключается между `edit` и `view` (enum RenderProfile).
- [ ] Все новые и изменяемые перечисления оформлены через `enum`; для существующих строковых типов подготовлена миграция или адаптерный слой на этапе внедрения.

## Примечания по реализации
- Соблюдать FSD: типы — в `shared/types/ui`, состояние — в `features/scene/model`, хук хоткеев — в `features/scene/lib/hooks`.
- Комментарии на русском к каждому новому публичному методу/экшену и новому компоненту/хуку.
- Лимит изменений на фазу ≤ 15 файлов; по необходимости дробить.
