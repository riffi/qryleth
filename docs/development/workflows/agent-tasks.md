# Agent Tasks / Агентские задачи

Документ описывает, как агенты создают и выполняют задачи, когда пользователь явно просит «сделай агентскую задачу».

> **TL;DR**  
> Работа оформляется цепочкой *эпик → задача → фазы* (или сразу «задача → фазы», если эпик не нужен).  
> Каждая фаза должна оставлять репозиторий в рабочем состоянии.  
> Перед стартом агент обязан открыть **agent-tasks.md** и свериться с [арх-принципами](../../architecture/design-principles.md)
> Фазы могут выполнять разные агенты.

---

## 1. Термины

| Термин     | Что это                                                         |
|------------|-----------------------------------------------------------------|
| **Epic**   | Верхнеуровневая цель; агрегирует связанные задачи.             |
| **Task**   | Папка с `AGENT_TASK_SUMMARY.md` и подпапкой `phases/`.          |
| **Phase**  | Изолированный шаг задачи (≤ 15 изменённых файлов; сборка = зелёная). |

---

## 2. Файловая структура

```text
agent-content/
|   ├─agent-tasks/
|   │  ├─ epics/
|   │     └─ 001-backend-integration/
|   │       ├─ epic.md
|   │       └─ tasks/
|   │          └─ 002-auth-endpoints/
|   │             ├─ AGENT_TASK_SUMMARY.md
|   │             └─ phases/
|   │                └─ phase_1_summary.md
|   ├─ tasks/                 # задачи, НЕ привязанные к эпикам
|   │  └─ 003-fix-modal-scroll/…
|   └─ manager-state.json     # глобальное состояние нумерации
```

---

## 3. Workflow
Как для эпика, так и для задачи использовать общую глобальную нумерацию. **Прочитать `manager-state.json`** для получения следующего номера и обновить `nextTaskId`.

### 3.0 Epic-flow

| Шаг               | Действие                                                                                                                                     |
|-------------------|----------------------------------------------------------------------------------------------------------------------------------------------|
| **Создание**      | `epics/<id>-<slug>/epic.md` с YAML-шапкой:<br>`id: <number>`<br>`title: "Название эпика"`<br>`status: planned / in-progress / done`<br>`created: 2025-08-07`<br>`tags:` … |
| **Содержимое**    | Цель, контекст, high-level-вехи, перечень задач со статусами и ссылками(если задача поставлена),  статус выполнения.                         |
| **Привязка задач**| Каждая дочерняя задача хранится в `epics/<slug>/tasks/` и имеет `epic: номер эпика` в YAML-шапке.                                            |
| **Закрытие**      | После завершения всех задач агент ставит `status: done` в `epic.md` и создает `EPIC_REPORT.md` (сводка).                                     |

При создании эпика дочерние задачи создавать сразу не нужно, если пользователь явно об этом не попросил.

---

### 3.1 Создание новой задачи

Обязательная YAML‑шапка `AGENT_TASK_SUMMARY.md` (строго сверху файла, без пустых строк до `---`):

```yaml
---
id: <number>              # обязателен. Берём из manager-state.json
epic: <number|null>       # ID эпика (число) или null. Альтернатива (устар.): относительный путь '../epic.md'
title: <string>           # Название задачи
status: planned           # одно из: planned | in-progress | done
created: YYYY-MM-DD       # дата создания
updated: YYYY-MM-DD       # дата последнего обновления (обязателен при любом изменении)
owner: <string>           # optional. Например: team-ui или @nickname
tags: [tag1, tag2]        # optional. Массив строк
phases:
  total: <number>         # optional. Плановое число фаз
  completed: <number>     # optional. Сколько фаз завершено на момент обновления
---
```

Требования к содержимому `AGENT_TASK_SUMMARY.md`:
- H1: `# <Человекочитаемое название задачи>`
- H2: `## Контекст` - подробное описание контекста задачи
- Обязательный раздел «Список фаз» — ПЛАН работ. Для каждой фазы при создании задачи нужно подробно описать, что именно будет сделано (чек‑лист), без создания файлов фазы. После выполнения фазы в этот раздел добавляется отметка статуса (done) и ссылка на файл `phases/phase_*_summary.md`.
  - Рекомендуемый формат для каждой фазы внутри «Список фаз»:
    - Заголовок `### ⏳/✅ Фаза N: Короткий заголовок`
    - Подробная техническая постановка, перечень задач (чек‑лист, маркеры `-`)
    - После выполнения: ссылка `**Отчёт**: [phases/phase_N_summary.md](phases/phase_N_summary.md)`

Шаги:

| Шаг | Действие |
|-----|----------|
| 0   | **Прочитать `manager-state.json`** для получения следующего номера и обновить `nextTaskId`. |
| 1   | Создать папку `tasks/<id>-<slug>/` **или** `epics/<epic>/tasks/<id>-<slug>/`. |
| 2   | Создать `AGENT_TASK_SUMMARY.md` с YAML по шаблону выше. |
| 3   | Провести экспресс‑аудит кода. |
| 4   | В теле файла описать контекст, цели, и **Список фаз**. |
| 5   | Обязательно включить последнюю фазу «Обновить основную проектную документацию docs». |

---

### 3.2 Выполнение фазы

ВАЖНО: файлы `phases/phase_<N>_summary.md` НЕ создаются при постановке задачи. Их создают ТОЛЬКО после фактического завершения фазы.

Обязательная YAML‑шапка каждого `phases/phase_<N>_summary.md` (создаётся после выполнения фазы):

```yaml
---
id: <number>              # ID задачи (тот же, что и в AGENT_TASK_SUMMARY.md)
phase: <number>           # номер фазы; поддерживаются подфазы: 4.1, 4.2 (number или string)
title: "Фаза <N>: Короткий тех. заголовок"  # краткий тех. заголовок для парсинга
status: planned           # planned | in-progress | done
created: YYYY-MM-DD       # дата начала фазы
updated: YYYY-MM-DD       # дата последнего обновления
filesChanged: <number>    # optional. Кол-во изменённых файлов (контроль ≤ 15)
notes:                    # optional. Короткие машинно-читаемые метки
  - key: value
---
```

Требования к структуре:
- H1 дублирует `title` для удобства чтения.
- В конце файла — раздел «Результат» с чек‑листом критериев успешности.

Процесс:
1. Прочитать `AGENT_TASK_SUMMARY.md` и предыдущие фазы.
2. Если планируемый diff > 15 файлов → разбить фазу; обновить «Список фаз» в задаче.
3. По завершении:
   - создать `phases/phase_<N>_summary.md` с YAML по шаблону;
   - обновить YAML задачи (`updated`, `phases.completed`), отмечая статус фазы в «Список фаз» (✅ done) и добавив ссылку на отчёт;
   - если фаза последняя и все выполнено — перевести `status` задачи в `done`.

---

### 3.3 Правила разбиения на фазы

| Правило                              | Пояснение                                                         |
|--------------------------------------|-------------------------------------------------------------------|
| ≤ 15 изменённых файлов               | Дробим крупные изменения.                                         |
| Сборка / линт / тесты — зелёные      | Обязательно после каждой фазы.                                    |
| Однотипные изменения → отдельные фазы| Например, UI-фиксы и backend-логика отдельно.                     |
| Формат постановки                    | Каждая фаза — конкретная доработка; код должен оставаться валидным.|

---

### 3.4 Завершение задачи

| Шаг | Действие |
|-----|----------|
| 1   | Создать `TASK_COMPLETION_REPORT.md` (сводка + ссылки на все `phase_*`). |
| 2   | Изменить `status:` в YAML задачи на `done`, обновить `updated`, `phases.completed = phases.total`. |
| 3   | Если задача в эпику — проверить, можно ли закрыть эпик (см. 3.0). |
| 4   | Обновить `manager-state.json` (`metadata`, `lastModified`). |
---

## 4. Чек-лист агента

| Обязанность                                           | ✓/✗ |
|-------------------------------------------------------|-----|
| Перед началом фазы перечитать `agent-tasks.md`        | ✓   |
| Заполнять строгий YAML в задаче и фазах               | ✓   |
| Обновлять `updated` и прогресс по фазам в задаче      | ✓   |
| Держать сборку зелёной после фазы                     | ✓   |
| Обновлять доки при изменении публичных API            | ✓   |
| Менять > 15 файлов в одной фазе                       | ✗   |
| Удалять историю задач или фаз                         | ✗   |

---

## 6. Шаблоны (скопируйте при создании)

### 6.1 AGENT_TASK_SUMMARY.md (шапка)

```yaml
---
id: 123
epic: 7
status: planned
created: 2025-08-08
updated: 2025-08-08
owner: team-ui
tags: [frontend, backend]
phases:
  total: 5
  completed: 0
---
```

### 6.2 phases/phase_1_summary.md (шапка)

```yaml
---
id: 123
phase: 1
title: "Фаза 1: Настройка проекта"
status: done
created: 2025-08-08
updated: 2025-08-08
filesChanged: 9
---
```

### 6.3 epic.md (шаблон)

**ВАЖНО: Данную структуру необходимо обязательно соблюдать при создании эпика.**

```yaml
---
id: <number>
title: "Название эпика"
status: planned
created: YYYY-MM-DD
updated: YYYY-MM-DD
tags: [tag1, tag2]
---
```

```markdown
# Название эпика

## Цель
[Краткое описание высокоуровневой цели эпика]

## Контекст
[Контекст и обоснование - почему этот эпик нужен]

## Основные вехи
- [ ] Веха 1: [описание]
- [ ] Веха 2: [описание]
- [ ] Веха 3: [описание]

## Задачи эпика

### ⏳ Задача 1: [Название задачи]
**Статус:** planned  
**Ссылка:** -  
**Описание:** [Краткое описание задачи]

### ⏳ Задача 2: [Название задачи]
**Статус:** planned  
**Ссылка:** -  
**Описание:** [Краткое описание задачи]

## Критерии завершения
- [ ] Все задачи эпика выполнены
- [ ] Обновлена документация
- [ ] Проведено тестирование

## Статус выполнения
**Текущий статус:** planned  
**Прогресс:** 0/X задач завершено  
**Последнее обновление:** YYYY-MM-DD
```

### 6.4 Шаблон AGENT_TASK_SUMMARY.md 

```markdown


## Обязательная информация
!Правила работы с агентскими задачами: [agent-tasks.md](../../../../docs/development/workflows/agent-tasks.md)
**ВАЖНО**: При выполнении каждой из фаз необходимо обязательно сверяться с требованиями и принципами из указанного файла.

## Цели
[Краткое описание целей задачи]

## Контекст
[Подробное описание контекста задачи]

## Список фаз

### ⏳ Фаза 1: Настройка архитектуры и базовой структуры проекта
- Создание папки `apps/agent-tasks-ui`
- Настройка Vite проекта с React, TypeScript, Mantine
- Настройка Express сервера
- Базовая файловая структура фронтенда и бэкенда

### ⏳ Фаза 2: Backend API для чтения задач
- Создание Express роутов для получения списка задач и эпиков
- Парсинг markdown файлов и извлечение YAML метаданных
- API endpoints: GET /api/tasks, GET /api/epics, GET /api/tasks/:id, GET /api/epics/:id/tasks, GET /api/manager

### ⏳ Фаза 3: Frontend базовый интерфейс
- Настройка Mantine UI компонентов
- Создание компонентов для отображения списка задач
- Базовая навигация и layout приложения
- Подключение к backend API

...
```

---

## 5. Связанные документы

- [Design Principles](../../architecture/design-principles.md)
- [LLM Integration](../../features/ai-integration/llm-integration.md)
