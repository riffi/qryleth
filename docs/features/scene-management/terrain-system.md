# –°–∏—Å—Ç–µ–º–∞ —Ç–µ—Ä—Ä–µ–π–Ω–æ–≤ (–ª–∞–Ω–¥—à–∞—Ñ—Ç–Ω—ã–µ —Å–ª–æ–∏)

–î–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –ª–∞–Ω–¥—à–∞—Ñ—Ç–Ω—ã—Ö —Å–ª–æ—ë–≤: –µ–¥–∏–Ω—ã–π —Å—ç–º–ø–ª–µ—Ä –≤—ã—Å–æ—Ç—ã, –ø–æ–¥–¥–µ—Ä–∂–∫—É PNG heightmap –∏ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–π —Ä–µ–ª—å–µ—Ñ–∞ (TerrainOps), –º–æ–¥—É–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–µ—Ä—Ä–µ–π–Ω–∞, –∞ —Ç–∞–∫–∂–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è UI.

---

## –ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

- üß≠ –ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã: –≤—ã—Å–æ—Ç—ã –∏ –Ω–æ—Ä–º–∞–ª–∏ —Å—á–∏—Ç–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ `GfxHeightSampler` –∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∏ –≤ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–µ, –∏ –ø—Ä–∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏–∏ –æ–±—ä–µ–∫—Ç–æ–≤. –£ —Å—ç–º–ø–ª–µ—Ä–∞ –µ—Å—Ç—å –∂–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª: `isReady()`, `ready()`, `dispose()`.
- üñºÔ∏è –ü–æ–¥–¥–µ—Ä–∂–∫–∞ PNG heightmap: –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –≤ IndexedDB (Dexie), –±–∏–ª–ª–∏–Ω–µ–π–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è —è—Ä–∫–æ—Å—Ç–∏ –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–∞—Å—Å–∏–≤–∞ –≤—ã—Å–æ—Ç (Float32Array) –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å–µ–º–ø–ª–∏–Ω–≥–∞.
- üîÅ –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ: –∫–∞—Ä—Ç—ã –º–∞—Å—à—Ç–∞–±–∏—Ä—É—é—Ç—Å—è –¥–æ ‚â§200px –ø–æ –±–æ–ª—å—à–µ–π —Å—Ç–æ—Ä–æ–Ω–µ, –∏–∑ –Ω–∏—Ö –∏–∑–≤–ª–µ–∫–∞—é—Ç—Å—è –≤—ã—Å–æ—Ç—ã –∏ —Å—á–∏—Ç–∞–µ—Ç—Å—è —Ö—ç—à; –ø—Ä–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–∏ —Ö—ç—à–∞ –∞—Å—Å–µ—Ç –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è (–Ω–æ–≤—ã–π –Ω–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è).
- üß∞ TerrainOps: –ª–æ–∫–∞–ª—å–Ω—ã–µ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Ä–µ–ª—å–µ—Ñ–∞ (add/sub/set) —Å —Ñ—É–Ω–∫—Ü–∏—è–º–∏ –∑–∞—Ç—É—Ö–∞–Ω–∏—è –∏ —ç–ª–ª–∏–ø—Ç–∏—á–µ—Å–∫–∏–º–∏ –∑–æ–Ω–∞–º–∏ –≤–ª–∏—è–Ω–∏—è.
 - üß© –ú–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: –∏—Å—Ç–æ—á–Ω–∏–∫–∏, —Å–µ–º–ø–ª–∏–Ω–≥, —ç—Ñ—Ñ–µ–∫—Ç—ã, –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏ –∫—ç—à–∏ –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –º–æ–¥—É–ª–∏ –ø–æ–¥ `src/features/scene/lib/terrain/`.
 - üß† –ö—ç—à–∏ —Å TTL/LRU: `assets/heightmapCache.ts` –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç –ø–∞–º—è—Ç—å –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç `invalidate(assetId)`/`clear()`.
 

---

## UI: —Å–æ–∑–¥–∞–Ω–∏–µ —Å–ª–æ—è –ª–∞–Ω–¥—à–∞—Ñ—Ç–∞

–ö–æ–º–ø–æ–Ω–µ–Ω—Ç: `src/features/scene/ui/objectManager/SceneLayerModals.tsx`

–ü–æ—Ç–æ–∫ —Å–æ–∑–¥–∞–Ω–∏—è:

1. –í—ã–±–µ—Ä–∏—Ç–µ ¬´–§–æ—Ä–º–∞ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏¬ª ‚Üí –†–µ–ª—å–µ—Ñ–Ω–∞—è –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å (—Ç–µ—Ä—Ä–µ–π–Ω)
2. –ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö —Ç–µ—Ä—Ä–µ–π–Ω–∞:
   - `Perlin` ‚Äî –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —à—É–º
 - `Heightmap` ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ PNG
3. –î–ª—è heightmap ‚Äî –∑–∞–≥—Ä—É–∑–∏—Ç–µ PNG –∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
   - –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è/–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ (min/max)
   - –†–µ–∂–∏–º –∫—Ä–∞—ë–≤ (wrap: `clamp` | `repeat`)
4. –°–æ–∑–¥–∞–π—Ç–µ —Å–ª–æ–π ‚Üí PNG —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ Dexie (—Å –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–µ–π –ø–æ —Ö—ç—à—É –≤—ã—Å–æ—Ç), —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è `GfxTerrainConfig` –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ store.

---

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

- –¢–∏–ø—ã: —Å–º. `docs/api/types/terrain.md`
- –°—ç–º–ø–ª–µ—Ä: `src/features/scene/lib/terrain/GfxHeightSampler.ts`
- –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è heightmap: `src/features/scene/lib/terrain/HeightmapUtils.ts`
- –†–µ–Ω–¥–µ—Ä–∏–Ω–≥: `src/features/scene/ui/renderer/landscape/LandscapeLayer.tsx`
- –†–∞–∑–º–µ—â–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤: `src/features/scene/lib/placement/ObjectPlacementUtils.ts`
- –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥–µ–æ–º–µ—Ç—Ä–∏–∏: `src/features/scene/lib/terrain/GeometryBuilder.ts` (`buildGfxTerrainGeometry`, `decideSegments`)
- –ú–æ–¥—É–ª–∏ —Ç–µ—Ä—Ä–µ–π–Ω–∞:
  - `heightSources/PerlinSource.ts`, `heightSources/HeightmapSource.ts`
  - `sampling/uv.ts`, `sampling/bilinear.ts`
  - `ops/spatialIndex.ts`, `ops/applyOps.ts`
  - `effects/edgeFade.ts`
  - `assets/heightmapCache.ts` (–∫—ç—à ImageData –∏ —á–∏—Å–ª–æ–≤–æ–≥–æ –ø–æ–ª—è –≤—ã—Å–æ—Ç, –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è, TTL/LRU)

---

## –ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ heightmap

```ts
import type { GfxTerrainConfig } from '@/entities/terrain'

const cfg: GfxTerrainConfig = {
  worldWidth: 120,
  worldHeight: 120,
  edgeFade: 0.15,
  source: {
    kind: 'heightmap',
    params: {
      assetId: 'dexie-asset-id',
      imgWidth: 2048,
      imgHeight: 2048,
      min: -2,
      max: 12,
      wrap: 'clamp'
    }
  }
}
```

### –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å—ç–º–ø–ª–µ—Ä–∞ –∏ –≥–µ–æ–º–µ—Ç—Ä–∏–∏ –≤ —Ä–µ–Ω–¥–µ—Ä–µ

```ts
import { createGfxHeightSampler } from '@/features/scene/lib/terrain/GfxHeightSampler'
import { buildGfxTerrainGeometry } from '@/features/scene/lib/terrain/GeometryBuilder'

const sampler = createGfxHeightSampler(cfg)
await sampler.ready?.() // –¥–ª—è heightmap –¥–æ–∂–¥–∞—Ç—å—Å—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
const geometry = buildGfxTerrainGeometry(cfg, sampler)
```

---

## –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –∏ –º–∏–≥—Ä–∞—Ü–∏—è

- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–µ–≥–æ –ø–æ–ª—è `noiseData` —É–¥–∞–ª–µ–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `terrain: GfxTerrainConfig`.
- Scene API –º–µ—Ç–æ–¥ `adjustInstancesForPerlinTerrain` —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–æ –≤—Å–µ–º–∏ —Ç–∏–ø–∞–º–∏ —Ç–µ—Ä—Ä–µ–π–Ω–æ–≤ –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã.

### –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–µ–π

- –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏–ª–∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–∏ –∞—Å—Å–µ—Ç–∞ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `invalidate(assetId)` –∏–∑ `assets/heightmapCache.ts` (–∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç—Å—è –≤ `HeightmapUtils.ts`).

---

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- –ö—ç—à –∑–Ω–∞—á–µ–Ω–∏–π –≤—ã—Å–æ—Ç –≤ `GfxHeightSampler` —É—Å–∫–æ—Ä—è–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã.
- –ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω–¥–µ–∫—Å —É–º–µ–Ω—å—à–∞–µ—Ç —á–∏—Å–ª–æ –ø—Ä–æ–≤–µ—Ä–æ–∫ –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ `TerrainOps`.
- –ì–µ–æ–º–µ—Ç—Ä–∏—è –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞/–Ω–∞—Å—Ç—Ä–æ–π–∫–∏/–∑–∞–≥—Ä—É–∑–∫–µ ImageData.
- –í—ã—Å–æ—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ Dexie –∏ –∏–Ω–¥–µ–∫—Å–∏—Ä—É—é—Ç—Å—è –ø–æ —Ö—ç—à—É ‚Äî –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–¥–µ–Ω—Ç–∏—á–Ω—ã—Ö PNG –Ω–µ —Å–æ–∑–¥–∞—é—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤.
- –í `assets/heightmapCache.ts` –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è TTL/LRU –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –ø–∞–º—è—Ç–∏; –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ–Ω—ã `invalidate(assetId)` –∏ –≥–ª–æ–±–∞–ª—å–Ω—ã–π `clear()`.

