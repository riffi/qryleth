# Биомы (управление скаттерингом объектов)

Биомы позволяют автоматически размещать (scatter) объекты из библиотеки внутри заданных областей сцены. Система v2 опирается на единый параметр плотности `spacing`, поддерживает страты (плоские слои внутри биома) и детерминированную генерацию по `seed`.

Связанные материалы:
- Типы биомов: ../../api/types/biomes.md
- Scene API (методы для биомов): ../../api/scene-api.md
- Скриптинг: ./biomes-in-scripting-panel.md

---

## Возможности

- Создание областей биома любой формы: прямоугольник, круг, произвольный многоугольник.
- Алгоритмы скаттеринга: `random` (с мягким постфильтром по расстоянию) и `poisson` (blue‑noise) — управляются через `spacing`.
- Страты: частичный оверрайд скаттеринга внутри биома (локальные `spacing`, `edge`, `transform`, `source`).
- Детерминизм: локальные сиды на страту; повторяемость генерации при одинаковых входных данных.
- Привязка инстансов к биому: у создаваемых инстансов сохраняется `biomeUuid`.
- CRUD для биомов, scatter/regen с авто‑подстройкой по террейну (если есть landscape‑слой).
 - Наклон по нормали поверхности: через `scattering.transform.alignToSurfaceNormal` можно включить мягкий автоповорот инстансов по нормали террейна (наклоны X/Z), с ограничением максимального угла и опциональным учётом кривизны.

---

## Потоки работы (UX)

- Создание биома → настройка `area` и `scattering` → (опционально) добавление страт → запуск scatter/regenerate.
- Редактирование параметров → повторный scatter/regenerate.
- Включение/выключение видимости биома (для отладки и UI).

---

## Основные операции (Scene API)

- Получить биомы: `SceneAPI.getBiomes()`
- Добавить биом: `SceneAPI.addBiome(biome)`
- Обновить биом: `SceneAPI.updateBiome(uuid, updates)`
- Удалить биом: `SceneAPI.removeBiome(uuid)`
- Выполнить скаттеринг (append): `await SceneAPI.scatterBiome(uuid, { landscapeLayerId? })`
- Полная регенерация (replace): `await SceneAPI.regenerateBiomeInstances(uuid, { landscapeLayerId?, forceDelete? })`
- Получить инстансы биома: `SceneAPI.getInstancesByBiomeUuid(uuid)`

> Примечание: при scatter/regen движок автоматически создаёт `SceneObject` для нужных `libraryUuid`, если их нет в сцене.

---

## Рекомендации

- Для `random` используйте `spacing` как «мягкий» барьер (в движке применяется постфильтр `spacing * 0.9`).
- Для `poisson` `spacing` является `minDistance`; итоговое число ограничивается по hex‑packing.
- Если `source` не задан — берётся вся библиотека (веса равны). Для предсказуемых результатов задайте `source` явно.
- Теги фильтра сравниваются в нижнем регистре; нормализуйте теги библиотеки.
- Межстратные коллизии по `spacing` пока не учитываются (может привести к локальным сгущениям на границах страт).
 - Для корректного наклона по нормали необходимо наличие ландшафтного слоя с поддержкой `GfxHeightSampler.getNormal`. При его отсутствии параметр `alignToSurfaceNormal` будет проигнорирован.

---

## Ограничения

- Нет обратной совместимости со старым форматом (до v2). Требуется пересохранение биомов в текущем формате.
- Эвристика `N_max` по hex‑packing может отличаться от теоретического предела для сложных областей с большим `edgeFade`.

---

## См. также

- Типы: ../../api/types/biomes.md
- Скриптинг: ./biomes-in-scripting-panel.md
