# Процедурная генерация деревьев

Краткое описание возможностей генератора деревьев в Object Editor, набора параметров, а также используемых при рендеринге оптимизаций. Документ относится к разделу «Функциональность» и описывает поведение и UX‑потоки. За реализацию типов/компонентов см. ссылки в конце.

## Назначение

- Создание параметрических деревьев внутри редактора объектов (Object Editor).
- Получение готового набора примитивов (ствол/ветви/листья) и материалов.
- Быстрый предпросмотр в Object Editor с тем же визуальным видом, что и в Scene Editor.

## Как пользоваться

1. Откройте Object Editor → вкладка «Генерация» справа (Object Management Panel).
2. Задайте параметры (см. ниже) и цвета материалов «Кора»/«Листья».
3. При необходимости включите «Очистить перед генерацией», чтобы заменить текущие примитивы.
4. Нажмите «Сгенерировать» — дерево появится в сцене Object Editor.

### UI: ключевые контролы
- «Сужение ствола к верху» — общий слайдер taper для всех стволов (основного и дочерних).
- «Скос сегментов ствола» — 0: без скоса (как раньше); 1: каждый сегмент ствола сильно наклоняется в случайном направлении. Стыки остаются бесшовными за счёт перекрытия и «воротника».
- Секция «Разветвление ствола»:
  - «Уровни» — сколько этапов ответвлений создавать (0 — выключено).
  - «Ответвлений/уровень» — сколько дочерних стволов на каждом уровне.
  - «Угол (°)» — базовый наклон дочерних стволов от вертикали.
  - «Высота доч. ствола» — относительная высота дочернего ствола к родительскому.
  - Случайность (общий параметр) влияет на азимут/наклон/высоту/сегменты дочерних стволов.
 - «Привязка ветвей к верху» — 0: ветви формируются равномерно по высоте; 1: ветви концентрируются ближе к верхним сегментам.
 - «Стремление ветвей вверх» — 0: без предпочтения; 1: ветки стараются ориентироваться вверх (направления «вниз» сильно штрафуются).
- Секция «Ветви»:
  - «Базовый угол (°)» — базовый наклон ветвей. Используется как значение по умолчанию для всех уровней.
  - «Угол L1 (°)» — наклон ветвей первого уровня (если пусто — используется базовый угол).
  - «Угол L2+ (°)» — наклон ветвей уровней ≥2 (если пусто — используется базовый угол).
- «Тип листвы»: Билборды | Сферы | Хвойная (крест).
- «Распределение листвы»: На концах | Вдоль ветви. Для режима «Вдоль ветви» доступен слайдер «Плотность (класт./м)».

### Управление конфигурацией (JSON)
- «Экспорт JSON» — открывает всплывающее окно с текущими параметрами генерации в формате JSON. Можно отредактировать и скопировать.
- «Импорт JSON» — открывает окно для вставки JSON. Кнопка «Применить» выполняет полную замену параметров генерации на переданные.
  - Обязательные поля: `seed`, `trunkHeight`, `trunkRadius`, `trunkSegments`, `branchLevels`, `branchesPerSegment`, `branchLength`, `branchRadius`, `branchAngleDeg`, `randomness`, `leavesPerBranch`, `leafSize`.
  - Опциональные поля: `trunkTaperFactor`, `trunkShearStrength`, `trunkBranchLevels`, `trunkBranchesPerLevel`, `trunkBranchAngleDeg`, `trunkBranchChildHeightFactor`, `branchTopBias`, `angleSpread`, `leafShape`, `leafPlacement`, `leavesPerMeter`, `embedFactor`.

## Параметры генерации

-- seed — сид случайности (результат детерминирован при одинаковом seed).
-- trunkHeight — высота ствола; trunkSegments — число сегментов; trunkRadius — радиус у основания.
- trunkShearStrength — сила скоса сегментов ствола (0..1): 0 — без скоса; 1 — сильный наклон каждого сегмента в случайном азимуте при бесшовной стыковке.
 - trunkTaperFactor — коэффициент сужения ствола кверху (0..1). 0 — без сужения; рекомендуемые 0.2–0.6. Настраивается слайдером в UI.
- branchLevels — глубина ветвления; branchesPerSegment — среднее число ветвей на сегмент ствола.
- branchLength — базовая длина ветви (уменьшается на верхних уровнях); branchRadius — радиус ветви первого уровня.
 - branchLength — базовая длина ветви (уменьшается на верхних уровнях); branchRadius — радиус ветви первого уровня.
 - branchLengthJitter — разброс длины ветвей (0..1). Если не задан — берётся из общего параметра `randomness`.
- branchAngleDeg — угол наклона ветви от вертикали (в градусах).
 - branchAngleDeg — базовый угол наклона ветви от вертикали (в градусах).
 - branchAngleDegFirst — угол для ветвей первого уровня (если не задан — используется branchAngleDeg).
 - branchAngleDegNext — угол для ветвей уровней ≥2 (если не задан — используется branchAngleDeg).
 - branchUpBias — стремление веток ориентироваться вверх (0..1): 0 — без предпочтения; 1 — ветки обязательно «смотрят» вверх.
- angleSpread (0..1) — разброс наклона относительно branchAngleDeg:
  - 0 — без разброса (точно branchAngleDeg),
  - 1 — максимальный джиттер наклона (порядка ±50% от branchAngleDeg).
  - Азимут ветвей выбирается случайно равномерно в [0..2π].
- randomness — доля случайности для некоторых величин (например, длина ветви, количество ветвей).
- leavesPerBranch — число листьев на конце ветви (на последнем уровне).
- leafSize — базовый размер листа.
- leafShape — тип листвы: billboard (плоскость с маской) | sphere (объёмная сфера) | coniferCross (двойной крест для хвои).
 - leafPlacement — размещение листвы: 'end' (на концах) | 'along' (вдоль ветви).
 - leavesPerMeter — плотность кластеров вдоль ветви (для leafPlacement='along').
 - embedFactor (0..1) — коэффициент заглубления ветвей/стыков ствола внутрь родителя, чтобы скрыть торцевые крышки цилиндров. По умолчанию ≈ 0.6; при малых углах наклона фактическая глубина автоматически увеличивается до минимально достаточной.

## Что создаётся

Генератор возвращает примитивы и материалы; при сохранении объект будет состоять из:

- Ствол и ветви: примитивы `trunk` и `branch` (цилиндрическая геометрия сужения по высоте).
- Листья: примитив `leaf` с геометрией `{ radius, shape }`, где `shape = 'billboard' | 'sphere'`.
- Материалы: «Кора» и «Листья» (PBR‑параметры совместимы с MeshStandardMaterial). При отсутствии в объекте создаются автоматически.

Примечание: для корректных AABB Bounding Box утилита учитывает `trunk/branch` как цилиндры, `leaf` — как сферы по радиусу.

## Стыки без швов (утопление и «воротник»)

- Ветки «втапливаются» в родителя: основание каждой ветви располагается слегка внутри радиуса родительского цилиндра, а сам цилиндр ветви удлиняется вниз на глубину заглубления. Нижняя крышка ветви оказывается внутри родителя и не видна.
- Минимально достаточное заглубление: при малых углах между веткой и осью родителя генератор автоматически увеличивает глубину так, чтобы нижняя крышка гарантированно не выглядывала.
- Плавный переход у основания (воротник): в нижней части ветвей (≈15% высоты) радиус плавно уменьшается от увеличенного значения к номинальному. Аналогичный воротник создаётся на стыках сегментов ствола (с параметрами, рассчитанными от соседних радиусов), что убирает видимый шов между сегментами.

## Оптимизация производительности

Для сцен с большим количеством экземпляров деревьев и/или высокой детализацией применяется инстанс‑рендеринг.

 Scene Editor
- Кора (`trunk/branch`): один InstancedMesh на объект с модифицированным вершинным шейдером (unit‑cylinder + атрибуты aHeight/aRadiusTop/aRadiusBottom).
   - Дополнительно: шейдер поддерживает параметры воротника per‑instance (`aCollarFrac`, `aCollarScale`), которые дают мягкий профиль радиуса у основания ветвей/сегментов.
- Листья (billboard): один InstancedMesh на объект с плоской геометрией 1×1 и `alphaTest` маской формы (мягкие края, лёгкий изгиб, простая подсветка «на просвет»).
- Листья (sphere): отдельный InstancedMesh с единой сферой 1×1 и равномерным масштабом по радиусу.

 Object Editor
- Используются эквивалентные инстанс‑компоненты для несгруппированных примитивов, чтобы предпросмотр соответствовал сцене по виду и скорости.

## Избежание пересечений ветвей

Генератор подбирает направление каждой ветви из нескольких кандидатов и выбирает тот, который минимизирует пересечения:
- Проверяется проход по пути ветви относительно ствола (дискретная оценка радиуса ствола по высоте), добавляется штраф за попадание внутрь и близость.
- С уже размещёнными ветвями сравнивается минимальная дистанция между отрезками; штрафуется пересечение и слишком малый зазор.
- Вводится лёгкое предпочтение направлений «наружу» от оси ствола в XZ‑плоскости.
На следующих уровнях ветвления естественная близость к своему родителю у основания не штрафуется.

Дополнительно: ветки одного узла распределяются по азимуту равномернее. Для кандидатов с азимутом, похожим на уже выбранные ветки текущего узла, вводится штраф «схожести», поэтому ветви стремятся расходиться в разные стороны вокруг оси родителя, что делает крону естественнее.

## Примыкание листвы к веткам

- В режиме `leafPlacement='along'` кластеры листьев ставятся на поверхность ветки: берётся точка на оси ветви и смещается по радиальному направлению на расстояние `(radius + ε)`. Добавляется небольшой касательный джиттер, чтобы избежать «колец».
- В режиме `leafPlacement='end'` кластеры распределяются по окружности торца ветви на расстоянии `(radius + ε)`.
- Таким образом листва не «висит» в воздухе и не проваливается внутрь цилиндра ветки.

Планы (кратко)
- Инстанс‑рендер внутри групп в Object Editor; CPU‑куллинг чанков; LOD для листвы; шейдер «ветер».

## Ссылки на реализацию (API/код)

Типы и генератор
- Типы примитивов: `apps/qryleth-front/src/entities/primitive/model/types.ts` (trunk, branch, leaf).
- Параметры генерации: `apps/qryleth-front/src/features/editor/object/lib/generators/tree/types.ts`.
- Генерация: `apps/qryleth-front/src/features/editor/object/lib/generators/tree/generateTree.ts`.
  - Подбор направления и анти‑пересечения: функции `segmentDistance`, `trunkPathPenalty`, `outwardPenalty` и логика выбора лучшего кандидата.

UI
- Панель генерации: `apps/qryleth-front/src/features/editor/object/ui/GeneratorPanels/TreeGeneratorPanel.tsx`.

Инстанс‑рендер (Scene Editor)
- Кора: `apps/qryleth-front/src/shared/r3f/optimization/InstancedBranches.tsx`.
- Листья‑билборды: `apps/qryleth-front/src/shared/r3f/optimization/InstancedLeaves.tsx`.
- Листья‑сферы: `apps/qryleth-front/src/shared/r3f/optimization/InstancedLeafSpheres.tsx`.

Инстанс‑рендер (Object Editor)
- Кора: `apps/qryleth-front/src/features/editor/object/ui/renderer/objects/InstancedBranchesOE.tsx`.
- Листья‑билборды: `apps/qryleth-front/src/features/editor/object/ui/renderer/objects/InstancedLeavesOE.tsx`.
- Листья‑сферы: `apps/qryleth-front/src/features/editor/object/ui/renderer/objects/InstancedLeafSpheresOE.tsx`.

## Хранение и обмен данными

- В Object Editor при генерации с включённой опцией «Очистить перед генерацией» объект помечается как процедурный (`objectType: 'tree'`) и параметры сохраняются в `treeData`.
- В библиотеке объектов (`Dexie`) и в сохранённых сценах деревья сериализуются как параметры (`treeData`), массив `primitives` не сохраняется.
- Рендер 3D‑сцен (Scene Editor), offscreen‑превью и hover‑превью автоматически восстанавливают примитивы на лету из `treeData`.
- При экспорте обычных объектов формат остаётся прежним: `objectType` не задан, геометрия в `primitives`.
## Разветвление ствола (опционально)

Ствол может разветвляться на 1..N уровней: в верхней части создаются дочерние «стволы» с небольшим наклоном, наследующие те же правила утопления и «воротника». Для каждого уровня задаётся число дочерних стволов, их угол наклона и коэффициент высоты. Нижний радиус дочерних стволов автоматически равен верхнему радиусу родительского, поэтому переход получается бесшовным при любом значении «Сужения ствола к верху».

Случайность (зависит от общего параметра `randomness`):
- азимут дочерних стволов имеет случайную фазу и лёгкий джиттер между соседями;
- угол наклона варьируется примерно в пределах ±30% от базового значения (масштабируется `randomness`);
- высота дочерних стволов варьируется примерно в пределах ±25% от базового коэффициента (масштабируется `randomness`);
- количество сегментов дочернего ствола может случайно меняться на ±1 (с малой вероятностью, масштабируется `randomness`).
