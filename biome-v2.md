# Переработка структуры и скаттеринга биомов (v2)

Ниже зафиксирована обновлённая модель типов и поведение алгоритмов с опорой на единый параметр плотности — `spacing`.

- Канонический параметр плотности: `spacing` (в единицах сцены), он же минимальная желаемая дистанция между точками.
- Стратификация без «правил»: у каждой страты один частичный оверрайд настроек скаттеринга.
- Детерминизм: локальный `seed` для каждой страты вычисляется от биомного `seed` и индекса страты.
- Поля `edge`/`transform` опциональны и имеют фиксированные дефолты.
- Флаг видимости биома сохраняется.

## Типы (v2)
```typescript
// ===== Алгоритмы =====
export type GfxScatterAlgorithm = 'poisson' | 'random';

// ===== Дефолтные настройки скаттеринга на уровне биома =====
export interface GfxBiomeScatteringConfig {
  /** Алгоритм генерации точек */
  algorithm: GfxScatterAlgorithm;
  /** Базовый seed биома; детерминизируется дальше на уровне страт */
  seed?: number;
  /** Единственный канонический параметр плотности (единицы сцены) */
  spacing: number;
  /** Параметры затухания/смещения плотности у границ области (опционально) */
  edge?: GfxBiomeEdgeFalloff; // по умолчанию: fadeWidth=0, edgeBias=0, fadeCurve='linear'
  /** Случайные трансформации инстансов (опционально) */
  transform?: GfxBiomePlacementTransform; // по умолчанию: yaw=[0,360], scale=[1,1], offset=[0,0]
  /** Отбор источников из библиотеки (опционально) */
  source?: GfxBiomeSourceFilter;
}

// ===== Страты =====
export interface GfxStratum {
  /** Имя страты (для UI/логов) */
  name: string;
  /** Частичный оверрайд от биомных дефолтов скаттеринга */
  scattering?: Partial<GfxBiomeScatteringConfig>;
}

// ===== Биом =====
export interface GfxBiome {
  /** Уникальный идентификатор биома */
  uuid: string;
  /** Обязательное имя для UI */
  name: string;
  /** Область действия биома (geometry) */
  area: GfxBiomeArea;
  /** Видимость биома (для UI/отладки) */
  visible?: boolean;
  /** Дефолтная конфигурация скаттеринга для всего биома */
  scattering: GfxBiomeScatteringConfig;
  /** Необязательные страты; если пусто — один «плоский» слой без доп. оверрайдов */
  strata?: GfxStratum[];
}
```

Примечание по именованию и переиспользуемым типам:
- Сохраняем префикс `Biome` в специализированных типах: `GfxBiomeEdgeFalloff`, `GfxBiomePlacementTransform`, `GfxBiomeSourceFilter`, `GfxBiomeScatteringConfig`.
- Поля трансформации не переименовываем: `randomYawDeg`, `randomUniformScale`, `randomOffsetXZ`.
- В `GfxBiomeScatteringConfig` поле отбора источников — `source?` (ед. число), тип `GfxBiomeSourceFilter`.

## Дефолты параметров
- `edge` по умолчанию: `fadeWidth = 0`, `edgeBias = 0`, `fadeCurve = 'linear'`.
- `transform` по умолчанию: `randomYawDeg = [0, 360]`, `randomUniformScale = [1, 1]`, `randomOffsetXZ = [0, 0]`.
- Если `source` не задан, источник выбирается из полного множества библиотеки (без фильтрации и без весов).

## Единицы измерения
- Все длины, включая `spacing`, трактуются в «единицах сцены».

## Детерминизм генерации
- Базовый `seed` берётся из `biome.scattering.seed` (может быть `undefined`).
- Для страты с индексом `i` вычисляется локальный `seed`:
  - `seed_i = hash(biomeSeed, i)`; практически — `xfnv1a(`${biomeSeed}:${i}`)`.
- При отсутствии страт используется сам `biomeSeed` как локальный `seed`.

## Алгоритмы и использование spacing

Общее: `spacing` — минимально желаемая дистанция между точками. Для оценки максимума точек по площади применяется эвристика плотной (шестиугольной) упаковки.

- Оценка верхней границы точек по площади (вариант A, hex packing):
  - Плотность упаковки: `η ≈ 0.9069`.
  - Эффективная площадь «зоны влияния» одной точки: `A = π · (spacing / 2)^2`.
  - Оценка максимального числа точек в области `S`: `N_max = round( η · S / A )`.
  - `S` — оценка площади области биома.

### Poisson (blue‑noise)
- Использовать `spacing` напрямую как `minDistance` в Poisson‑disk семплере.
- Целевое количество кандидатов — `N_max` (см. выше), чтобы ограничить время генерации и приблизить результат к ожидаемой «ёмкости» области.
- Допустимо досоздавать точки до насыщения при условии соблюдения `minDistance`, но не превышая `N_max`.

### Random (равномерный с мягким фильтром расстояния)
- Генерировать равномерные кандидаты внутри области c учётом `edge` (fade/bias) и принятия по вероятности.
- Применять «мягкий» постфильтр расстояния: отбраковывать кандидаты, находящиеся ближе, чем `spacing · t` к уже принятым точкам, где `t ∈ (0,1)`, по умолчанию `t = 0.9`.
- Останавливаться при достижении `N_max` или по превышению бюджета попыток (например, `maxAttempts = max(2000, 50 · N_max)`).

Замечание: на текущем этапе страты НЕ учитывают коллизии друг с другом (межстратный `spacing` не применяется). Это может быть добавлено позднее.

## Поведение у границ (edge)
- `fadeWidth` задаёт ширину зоны затухания; вес точки плавно снижается к границе.
- `fadeCurve`: `'linear'` или `'smoothstep'` — профиль затухания.
- `edgeBias` ∈ [-1..1] смещает вероятность: `+1` — к центру, `-1` — к краям, `0` — нейтрально.

## Трансформации инстансов (transform)
- `randomYawDeg`: случайный поворот вокруг Y в градусах.
- `randomUniformScale`: равномерный масштаб в диапазоне.
- `randomOffsetXZ`: локальные случайные смещения по XZ.

## Источники (source)
- Используется существующий фильтр `GfxBiomeSourceFilter` (теги, исключения, include UUID, веса по UUID/тегам).
- Если `source` не задан, берётся вся библиотека без фильтрации, веса принимаются равными.

## Совместимость и ожидания
- Обязательное поле `name` у биома сохраняется (для UI и логов).
- Поле `visible` у биома сохраняется (для UI/отладки).
- Страты представлены единичным частичным оверрайдом `scattering` без внутреннего перечня «правил».
- Межстратные коллизии по `spacing` не учитываются на данном этапе.
