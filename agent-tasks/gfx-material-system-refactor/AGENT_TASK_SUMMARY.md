# Рефакторинг системы материалов GfxPrimitive

**ВАЖНО:** При выполнении каждой фазы обязательно сверяйтесь с требованиями в [agent-tasks.md](../../docs/development/workflows/agent-tasks.md)

## Контекст задачи

Сейчас материал примитива задается для каждого примитива прямо в GfxPrimitive, что приводит к дублированию материалов. Необходимо реорганизовать систему материалов для более эффективного управления и переиспользования.

### Текущая структура материалов

```typescript
// src/entities/primitive/model/types.ts
interface PrimitiveCommon {
  material?: {
    color?: string;
    opacity?: number;
    emissive?: string;
    emissiveIntensity?: number;
  };
}
```

### Анализ текущей архитектуры

1. **Типы примитивов** - в `src/entities/primitive/model/types.ts` определены все типы примитивов с материалами
2. **Рендеринг** - `src/shared/r3f/primitives/PrimitiveRenderer.tsx` обрабатывает материальные свойства
3. **AI интеграция** - `src/features/scene/lib/ai/tools/objectTools.ts` содержит Zod схемы для валидации
4. **CAD конвертер** - `cad2qryleth/converter.py` преобразует материалы из Blender

## План выполнения задачи

### Фаза 1: Создание системы глобальных материалов ✅ ВЫПОЛНЕНО
**Цель:** Создать глобальный реестр материалов и базовые типы

**Задачи:**
- ✅ Создать интерфейс GfxMaterial в entities и типы для материальной системы
- ✅ У GfxMaterial добавить uuid
- ✅ Реализовать глобальный реестр материалов (MaterialRegistry)
- ✅ Добавить предопределенные глобальные материалы (дерево, металл, земля, камень, стекло)
- ✅ Создать утилиты для работы с материалами и их резолвинга

**Выполненные файлы:**
- ✅ `src/entities/material/model/types.ts` - интерфейс GfxMaterial и типы
- ✅ `src/entities/material/index.ts` - экспорты entity
- ✅ `src/shared/lib/materials/MaterialRegistry.ts` - глобальный реестр
- ✅ `src/shared/lib/materials/globalMaterials.ts` - 10 предопределенных материалов
- ✅ `src/shared/lib/materials/materialResolver.ts` - утилиты резолвинга
- ✅ `src/shared/lib/materials/initializeMaterials.ts` - система инициализации
- ✅ `src/shared/lib/materials/index.ts` - экспорты библиотеки
- ✅ `src/entities/index.ts` - обновлены экспорты

[Подробности выполнения: phase_1_summary.md](phases/phase_1_summary.md)

### Фаза 2: Обновление типов примитивов и объектов ✅ ВЫПОЛНЕНО
**Цель:** Обновить типы для поддержки новой системы материалов

**Задачи:**
- Обновить PrimitiveCommon для поддержки ссылок на материалы через отдельные поля:
  - `objectMaterialUuid?: string` - ссылка на материал объекта
  - `globalMaterialUuid?: string` - ссылка на глобальный материал
- Добавить поле `materials?: GfxMaterial[]` в GfxObject для материалов объекта
- Сохранить поле `material?` для обратной совместимости
- Обновить связанные типы

**Выполненные файлы:**
- ✅ `src/entities/primitive/model/types.ts`
- ✅ `src/entities/object/model/types.ts`
- ✅ `src/shared/types/index.ts` (экспорт новых типов)

[Подробности выполнения: phase_2_summary.md](phases/phase_2_summary.md)

### Фаза 3: Обновление системы рендеринга ✅ ВЫПОЛНЕНО
**Цель:** Адаптировать систему рендеринга для работы с новой системой материалов

**Задачи:**
- Обновить PrimitiveRenderer для резолвинга материалов по uuid
- Обновить все компоненты рендеринга примитивов
- Добавить fallback для случаев, когда материал не найден

**Файлы для изменения:**
- `src/shared/r3f/primitives/PrimitiveRenderer.tsx`
- Все файлы в `src/shared/r3f/primitives/`

[Подробности выполнения: phase_3_summary.md](phases/phase_3_summary.md)

### Фаза 4: Обновление AI инструментов и схем валидации ✅ ВЫПОЛНЕНО
**Цель:** Адаптировать AI инструменты для работы с новой системой материалов

**Задачи:**
- ✅ Создать AI tool для получения списка глобальных материалов
- ✅ Обновить схемы валидации для поддержки materialUuid
- ✅ Обновить инструменты создания объектов для работы с материалами
- ✅ Добавить примеры использования в AI промптах

**Выполненные файлы:**
- ✅ `src/features/scene/lib/ai/tools/materialTools.ts` - инструменты работы с материалами
- ✅ `src/features/scene/lib/ai/tools/objectTools.ts` - обновленные схемы и логика
- ✅ `src/features/scene/lib/ai/tools/index.ts` - экспорты новых инструментов

[Подробности выполнения: phase_4_summary.md](phases/phase_4_summary.md)

### Фаза 5: Обновление хранилищ и API ✅ ВЫПОЛНЕНО
**Цель:** Адаптировать системы управления состоянием для новой системы материалов

**Задачи:**
- ✅ Обновить objectStore для работы с материалами объекта (добавить состояние выбранного материала, действия создания/удаления/обновления материалов)
- ✅ Добавить валидацию уникальности имен материалов в рамках объекта
- ✅ Обновить sceneStore для глобальных материалов
- ✅ Обновить sceneAPI для операций с материалами

**Выполненные файлы:**
- ✅ `src/features/object-editor/model/objectStore.ts` - добавлены материалы объекта, селекторы и действия
- ✅ `src/features/scene/model/sceneStore.ts` - добавлен доступ к глобальным материалам
- ✅ `src/features/scene/lib/sceneAPI.ts` - добавлены методы работы с материалами

[Подробности выполнения: phase_5_summary.md](phases/phase_5_summary.md)

### Фаза 6: Обновление UI компонентов
**Цель:** Адаптировать пользовательский интерфейс для работы с новой системой материалов

Фаза разбита на подфазы для управляемости изменений:

#### Фаза 6A: Создание ObjectManagementPanel с табуляцией ✅ ВЫПОЛНЕНО
- Создать компонент `ObjectManagementPanel` с двумя вкладками: "Примитивы" и "Материалы"
- Перенести существующий `PrimitiveManager` во вкладку "Примитивы"
- Подготовить структуру для вкладки "Материалы"
- Обновить `ObjectEditorR3F.tsx` для использования нового компонента вместо `PrimitiveManager`

[Подробности выполнения: phase_6A_summary.md](phases/phase_6A_summary.md)

#### Фаза 6B: Создание MaterialManager ✅ ВЫПОЛНЕНО
- Создать компонент `MaterialManager` для отображения списка материалов из `GfxObject.materials` верстку сделать по аналогии с PrimitiveManager
- Реализовать выбор материала из списка с интеграцией в objectStore
- Добавить модальное окно создания материала с валидацией уникальности имен
- Реализовать параметры материала по умолчанию при создании

[Подробности выполнения: phase_6B_summary.md](phases/phase_6B_summary.md)

#### Фаза 6C: Создание MaterialControlPanel ✅ ВЫПОЛНЕНО
- Создать специализированную левую панель для редактирования свойств выбранного материала
- Реализовать новые UI компоненты для удобного редактирования (цвет, прозрачность, излучение и др.)
- Добавить логику сохранения изменений в материалах объекта
- Обеспечить валидацию и user feedback

[Подробности выполнения: phase_6C_summary.md](phases/phase_6C_summary.md)

#### Фаза 6D: Интеграция и переключение панелей  
- Реализовать логику переключения между `PrimitiveControlPanel` и `MaterialControlPanel`
- Настроить корректное отображение левых панелей при выборе примитива или материала
- Обеспечить синхронизацию состояния между компонентами

#### Фаза 6E: Обновление PrimitiveControlPanel для выбора материалов
- Добавить селектор материалов (глобальные + материалы объекта) вместо прямого редактирования цвета
- Реализовать логику применения выбранного материала к примитиву через `objectMaterialUuid`/`globalMaterialUuid`
- Сохранить fallback для старой системы материалов (поле `material`)
- Обновить UI для интуитивного выбора материалов

**Файлы для изменения:**
- `src/features/object-editor/ui/ObjectManagementPanel/` (новый компонент)
- `src/features/object-editor/ui/PrimitiveManager/PrimitiveManager.tsx` (перенос в ObjectManagementPanel)
- `src/features/object-editor/ui/MaterialManager/` (новый компонент)
- `src/features/object-editor/ui/MaterialControlPanel/` (новый компонент)
- `src/features/object-editor/ui/PrimiviteControlPanel/PrimitiveControlPanel.tsx`
- `src/features/object-editor/ui/ObjectEditorR3F.tsx`

### Фаза 7: Обновление CAD конвертера
**Цель:** Адаптировать Python конвертер для поддержки новой системы материалов

**Задачи:**
- Обновить `_prim_to_schema` для использования materialUuid
- Добавить логику создания материалов на уровне объекта
- Обеспечить обратную совместимость

**Файлы для изменения:**
- `cad2qryleth/converter.py`

### Фаза 8: Миграция существующих данных и тестирование
**Цель:** Обеспечить корректную миграцию существующих объектов и протестировать систему

**Задачи:**
- Создать утилиты миграции для существующих объектов
- Обновить примеры объектов
- Провести тестирование всех компонентов системы

**Файлы для изменения:**
- `examples/object/` (обновление примеров)
- Утилиты миграции при необходимости

### Фаза 9: Обновление документации
**Цель:** Актуализировать документацию проекта

**Задачи:**
- Обновить API документацию
- Документировать новую систему материалов
- Обновить примеры использования

**Файлы для изменения:**
- `docs/api/types/README.md`
- `docs/features/` (соответствующие разделы)

## Архитектурные решения и подводные камни

### Иерархия резолвинга материалов
```typescript
// Приоритет резолвинга материалов:
// 1. Прямой материал примитива (material) - для обратной совместимости
// 2. Материал объекта по objectMaterialUuid
// 3. Глобальный материал по globalMaterialUuid  
// 4. Дефолтный материал (серый)

// Структура ссылок на материалы в примитиве:
interface PrimitiveCommon {
  // Обратная совместимость
  material?: {
    color?: string;
    opacity?: number;
    emissive?: string;
    emissiveIntensity?: number;
  };
  
  // Новая система ссылок
  objectMaterialUuid?: string;  // ссылка на материал объекта
  globalMaterialUuid?: string;  // ссылка на глобальный материал
}
```

### Материалы на уровне инстансов
**Решение:** Все инстансы одного объекта имеют одинаковые материалы. Материалы привязываются только к объекту, переопределения на уровне инстансов не нужны.

### Глобальный реестр материалов
**Решение:** Создается единый глобальный реестр материалов, доступный всем компонентам приложения. Глобальные материалы не дублируются в каждой сцене.

### AI интеграция
**Решение:** 
- Добавить AI tool для получения списка доступных глобальных материалов
- AI может либо использовать globalMaterialUuid из списка, либо создавать собственные материалы объекта
- При создании объекта AI описывает материалы в поле `materials` объекта

### Производительность и кэширование
- Глобальные материалы кэшируются в памяти через единый реестр
- Material resolver использует Map для быстрого доступа
- Сериализация только uuid материалов, не полных объектов

### Миграция данных
- Автоматическая миграция при загрузке старых объектов
- Создание дефолтных материалов для существующих цветов
- Сохранение старого формата как fallback

## Принципы реализации

1. **Обратная совместимость** - поддержка старого формата материалов на переходный период
2. **Строгая типизация** - использование TypeScript дискриминированных объединений
3. **Feature-Sliced Design** - соблюдение архитектурных принципов проекта
4. **Поэтапность** - каждая фаза должна оставлять приложение в работающем состоянии
5. **Производительность** - кэширование и оптимизация резолвинга материалов

## Связанные файлы

- [Design Principles](../../docs/architecture/design-principles.md)
- [GfxPrimitive Refactor Plan](../../docs/architecture/gfx_primitive_refactor_plan.md)
- [Agent Tasks Workflow](../../docs/development/workflows/agent-tasks.md)
