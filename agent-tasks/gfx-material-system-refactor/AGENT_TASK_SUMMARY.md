# Рефакторинг системы материалов GfxPrimitive

**ВАЖНО:** При выполнении каждой фазы обязательно сверяйтесь с требованиями в [agent-tasks.md](../../docs/development/workflows/agent-tasks.md)

## Контекст задачи

Сейчас материал примитива задается для каждого примитива прямо в GfxPrimitive, что приводит к дублированию материалов. Необходимо реорганизовать систему материалов для более эффективного управления и переиспользования.

### Текущая структура материалов

```typescript
// src/entities/primitive/model/types.ts
interface PrimitiveCommon {
  material?: {
    color?: string;
    opacity?: number;
    emissive?: string;
    emissiveIntensity?: number;
  };
}
```

### Анализ текущей архитектуры

1. **Типы примитивов** - в `src/entities/primitive/model/types.ts` определены все типы примитивов с материалами
2. **Рендеринг** - `src/shared/r3f/primitives/PrimitiveRenderer.tsx` обрабатывает материальные свойства
3. **AI интеграция** - `src/features/scene/lib/ai/tools/objectTools.ts` содержит Zod схемы для валидации
4. **CAD конвертер** - `cad2qryleth/converter.py` преобразует материалы из Blender

## План выполнения задачи

### Фаза 1: Создание системы глобальных материалов
**Цель:** Создать глобальный реестр материалов и базовые типы

**Задачи:**
- Создать интерфейс Material и типы для материальной системы
- Реализовать глобальный реестр материалов (MaterialRegistry)
- Добавить предопределенные глобальные материалы (дерево, металл, земля, камень, стекло)
- Создать утилиты для работы с материалами и их резолвинга

**Файлы для изменения:**
- `src/shared/types/material.ts` (новый файл)
- `src/shared/lib/materials/` (новая папка с MaterialRegistry и утилитами)

[Подробности выполнения: phase_1_summary.md](phases/phase_1_summary.md)

### Фаза 2: Обновление типов примитивов и объектов
**Цель:** Обновить типы для поддержки новой системы материалов

**Задачи:**
- Обновить PrimitiveCommon для поддержки ссылок на материалы через отдельные поля:
  - `objectMaterialId?: string` - ссылка на материал объекта
  - `globalMaterialId?: string` - ссылка на глобальный материал
- Добавить поле `materials?: Material[]` в GfxObject для материалов объекта
- Сохранить поле `material?` для обратной совместимости
- Обновить связанные типы

**Файлы для изменения:**
- `src/entities/primitive/model/types.ts`
- `src/entities/object/model/types.ts`
- `src/shared/types/index.ts` (экспорт новых типов)

[Подробности выполнения: phase_2_summary.md](phases/phase_2_summary.md)

### Фаза 3: Обновление системы рендеринга ✅ Выполнено
**Цель:** Адаптировать систему рендеринга для работы с новой системой материалов

**Задачи:**
- Обновить PrimitiveRenderer для резолвинга материалов по ID
- Обновить все компоненты рендеринга примитивов
- Добавить fallback для случаев, когда материал не найден

**Файлы для изменения:**
- `src/shared/r3f/primitives/PrimitiveRenderer.tsx`
- Все файлы в `src/shared/r3f/primitives/`

[Подребности выполнения: phase_3_summary.md](phases/phase_3_summary.md)

### Фаза 4: Обновление AI инструментов и схем валидации
**Цель:** Адаптировать AI инструменты для работы с новой системой материалов

**Задачи:**
- Создать AI tool для получения списка глобальных материалов
- Обновить схемы валидации для поддержки materialId
- Обновить инструменты создания объектов для работы с материалами
- Добавить примеры использования в AI промптах

**Файлы для изменения:**
- `src/features/scene/lib/ai/tools/objectTools.ts`
- `src/features/scene/lib/ai/tools/index.ts` (новый material tool)
- Другие AI-related файлы при необходимости

[Подробности выполнения: phase_4_summary.md](phases/phase_4_summary.md)

### Фаза 5: Обновление UI компонентов
**Цель:** Адаптировать пользовательский интерфейс для работы с новой системой материалов

**Задачи:**
- Обновить PrimitiveControlPanel для выбора материалов из списков (глобальных и объекта)
- Добавить в ObjectEditor функционал создания новых материалов объекта
- Создать компонент MaterialEditor для редактирования свойств материалов
- Добавить возможность управления материалами объекта (добавление, удаление, редактирование)
- Обновить формы редактирования примитивов

**Файлы для изменения:**
- `src/features/object-editor/ui/PrimiviteControlPanel/PrimitiveControlPanel.tsx`
- `src/features/object-editor/ui/MaterialEditor/` (новый компонент)
- `src/features/object-editor/ui/ObjectEditorR3F.tsx` (добавить панель материалов)
- `src/features/scene/ui/objectManager/` (компоненты управления объектами)

### Фаза 6: Обновление хранилищ и API
**Цель:** Адаптировать системы управления состоянием для новой системы материалов

**Задачи:**
- Обновить objectStore для работы с материалами
- Обновить sceneStore для глобальных материалов
- Обновить sceneAPI для операций с материалами

**Файлы для изменения:**
- `src/features/object-editor/model/objectStore.ts`
- `src/features/scene/model/sceneStore.ts`
- `src/features/scene/lib/sceneAPI.ts`

### Фаза 7: Обновление CAD конвертера
**Цель:** Адаптировать Python конвертер для поддержки новой системы материалов

**Задачи:**
- Обновить `_prim_to_schema` для использования materialId
- Добавить логику создания глобальных материалов
- Обеспечить обратную совместимость

**Файлы для изменения:**
- `cad2qryleth/converter.py`

### Фаза 8: Миграция существующих данных и тестирование
**Цель:** Обеспечить корректную миграцию существующих объектов и протестировать систему

**Задачи:**
- Создать утилиты миграции для существующих объектов
- Обновить примеры объектов
- Провести тестирование всех компонентов системы

**Файлы для изменения:**
- `examples/object/` (обновление примеров)
- Утилиты миграции при необходимости

### Фаза 9: Обновление документации
**Цель:** Актуализировать документацию проекта

**Задачи:**
- Обновить API документацию
- Документировать новую систему материалов
- Обновить примеры использования

**Файлы для изменения:**
- `docs/api/types/README.md`
- `docs/features/` (соответствующие разделы)

## Архитектурные решения и подводные камни

### Иерархия резолвинга материалов
```typescript
// Приоритет резолвинга материалов:
// 1. Прямой материал примитива (material) - для обратной совместимости
// 2. Материал объекта по objectMaterialId
// 3. Глобальный материал по globalMaterialId  
// 4. Дефолтный материал (серый)

// Структура ссылок на материалы в примитиве:
interface PrimitiveCommon {
  // Обратная совместимость
  material?: {
    color?: string;
    opacity?: number;
    emissive?: string;
    emissiveIntensity?: number;
  };
  
  // Новая система ссылок
  objectMaterialId?: string;  // ссылка на материал объекта
  globalMaterialId?: string;  // ссылка на глобальный материал
}
```

### Материалы на уровне инстансов
**Решение:** Все инстансы одного объекта имеют одинаковые материалы. Материалы привязываются только к объекту, переопределения на уровне инстансов не нужны.

### Глобальный реестр материалов
**Решение:** Создается единый глобальный реестр материалов, доступный всем компонентам приложения. Глобальные материалы не дублируются в каждой сцене.

### AI интеграция
**Решение:** 
- Добавить AI tool для получения списка доступных глобальных материалов
- AI может либо использовать globalMaterialId из списка, либо создавать собственные материалы объекта
- При создании объекта AI описывает материалы в поле `materials` объекта

### Производительность и кэширование
- Глобальные материалы кэшируются в памяти через единый реестр
- Material resolver использует Map для быстрого доступа
- Сериализация только ID материалов, не полных объектов

### Миграция данных
- Автоматическая миграция при загрузке старых объектов
- Создание дефолтных материалов для существующих цветов
- Сохранение старого формата как fallback

## Принципы реализации

1. **Обратная совместимость** - поддержка старого формата материалов на переходный период
2. **Строгая типизация** - использование TypeScript дискриминированных объединений
3. **Feature-Sliced Design** - соблюдение архитектурных принципов проекта
4. **Поэтапность** - каждая фаза должна оставлять приложение в работающем состоянии
5. **Производительность** - кэширование и оптимизация резолвинга материалов

## Связанные файлы

- [Design Principles](../../docs/architecture/design-principles.md)
- [GfxPrimitive Refactor Plan](../../docs/architecture/gfx_primitive_refactor_plan.md)
- [Agent Tasks Workflow](../../docs/development/workflows/agent-tasks.md)