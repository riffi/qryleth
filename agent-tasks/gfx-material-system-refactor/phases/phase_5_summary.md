# Фаза 5: Обновление хранилищ и API - Сводка выполнения

## Цель фазы
Адаптировать системы управления состоянием для новой системы материалов.

## Выполненные задачи

### 1. Обновление objectStore для работы с материалами объекта ✅
**Файл:** `src/features/object-editor/model/objectStore.ts`

**Добавленное состояние:**
- `materials: GfxMaterial[]` - список материалов объекта
- `selectedMaterialUuid: string | null` - UUID выбранного материала

**Добавленные действия:**
- `setMaterials(materials: GfxMaterial[])` - установить список материалов
- `addMaterial(material: CreateGfxMaterial)` - добавить новый материал
- `updateMaterial(materialUuid: string, updates: Partial<GfxMaterial>)` - обновить материал
- `removeMaterial(materialUuid: string)` - удалить материал
- `selectMaterial(materialUuid: string | null)` - выбрать материал для редактирования
- `isMaterialNameUnique(name: string, excludeUuid?: string)` - проверка уникальности имен

**Добавленные селекторы:**
- `useObjectMaterials()` - список материалов объекта
- `useSelectedMaterialUuid()` - UUID выбранного материала
- `useSelectedMaterial()` - выбранный материал

### 2. Валидация уникальности имен материалов ✅
Реализована в методе `isMaterialNameUnique` в objectStore. Проверяет уникальность имен материалов в рамках объекта с возможностью исключения конкретного UUID (для обновления).

### 3. Обновление sceneStore для глобальных материалов ✅
**Файл:** `src/features/scene/model/sceneStore.ts`

**Добавлено:**
- Импорт `materialRegistry` и `GfxMaterial`
- Селектор `useGlobalMaterials()` для доступа к глобальным материалам из MaterialRegistry

### 4. Обновление sceneAPI для операций с материалами ✅
**Файл:** `src/features/scene/lib/sceneAPI.ts`

**Добавленные методы:**
- `getGlobalMaterials()` - получить все глобальные материалы
- `getMaterialByUuid(materialUuid: string)` - найти материал по UUID (глобальный или объекта)
- `getObjectMaterials(objectUuid: string)` - получить материалы конкретного объекта
- `findObjectsUsingMaterial(materialUuid: string)` - найти объекты, использующие материал
- `getMaterialUsageStats()` - статистика использования материалов в сцене

## Архитектурные решения

### Управление состоянием материалов
1. **ObjectStore** - управляет материалами конкретного объекта
2. **SceneStore** - предоставляет доступ к глобальным материалам через MaterialRegistry
3. **SceneAPI** - предоставляет удобные методы для работы с материалами в контексте сцены

### Валидация и уникальность
- Имена материалов должны быть уникальными в рамках объекта
- Глобальные материалы управляются через MaterialRegistry
- Поддержка поиска материалов по UUID через объекты и глобальный реестр

### Интеграция с существующей системой
- Обратная совместимость с существующими примитивами
- Поддержка ссылок на материалы через `objectMaterialUuid` и `globalMaterialUuid`
- Автоматическая очистка выбора при удалении материала

## Контекст для следующих фаз

Система управления состоянием материалов готова для интеграции с UI компонентами. Следующие фазы должны использовать:

1. **ObjectStore** - для управления материалами в редакторе объектов
2. **SceneAPI** - для операций с материалами в AI инструментах и других компонентах
3. **Валидацию уникальности** - при создании новых материалов в UI

## Готовность к следующей фазе
- ✅ Хранилища обновлены и протестированы
- ✅ API методы для работы с материалами готовы
- ✅ Валидация уникальности реализована
- ✅ Селекторы для UI компонентов созданы

Система готова для реализации UI компонентов (Фаза 6).