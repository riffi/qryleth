# Фаза 6E: Обновление PrimitiveControlPanel для выбора материалов

**Статус:** ✅ ВЫПОЛНЕНО  
**Дата выполнения:** 30.07.2025

## Цель фазы

Добавить селектор материалов в PrimitiveControlPanel, заменив прямое редактирование цвета на выбор материалов из глобальных и объектных материалов.

## Выполненные задачи

### 1. Анализ текущей реализации
- Изучен текущий компонент `PrimitiveControlPanel.tsx`
- Определена текущая логика работы с цветом через `material.color`
- Проанализированы зависимости и структура компонента

### 2. Изучение системы материалов
- Изучен `MaterialRegistry` для работы с глобальными материалами
- Проанализированы селекторы `objectStore` для материалов объекта
- Понимание типов `GfxMaterial` и логики резолвинга

### 3. Обновление импортов и зависимостей
- Заменен `ColorInput` на `Select` из Mantine
- Добавлен импорт `useObjectMaterials` из objectStore
- Добавлен импорт `materialRegistry` для доступа к глобальным материалам

### 4. Реализация логики выбора материалов
- **Создана функция `handleMaterialChange`:** применяет выбранный материал к примитиву через `globalMaterialUuid` или `objectMaterialUuid`
- **Создана функция `getAvailableMaterials`:** формирует список доступных материалов с группировкой (глобальные + объектные)
- **Создана функция `getCurrentMaterialUuid`:** получает текущий UUID материала примитива

### 5. Обновление UI
- Заменен `ColorInput` на `Select` с группировкой материалов
- Добавлен placeholder "Выберите материал"
- Реализована возможность очистки выбора (clearable)
- Добавлен поиск по материалам (searchable)
- Добавлено отображение fallback цвета для обратной совместимости

## Измененные файлы

### `src/features/object-editor/ui/PrimiviteControlPanel/PrimitiveControlPanel.tsx`
**Изменения:**
- Заменен импорт `ColorInput` на `Select`
- Добавлены импорты для работы с материалами
- Заменена функция `handleColorChange` на `handleMaterialChange`
- Добавлены вспомогательные функции для работы с материалами
- Обновлен UI блок выбора материала

## Ключевые особенности реализации

### 1. Поддержка двух типов материалов
```typescript
// Определение типа материала и применение соответствующих полей
if (isGlobalMaterial) {
  updates.globalMaterialUuid = materialUuid
  updates.objectMaterialUuid = undefined
} else {
  updates.objectMaterialUuid = materialUuid
  updates.globalMaterialUuid = undefined
}
```

### 2. Группировка в селекторе
```typescript
const materials = [
  ...globalMaterials.map(m => ({
    value: m.uuid,
    label: `${m.name} (глобальный)`,
    group: 'Глобальные материалы'
  })),
  ...objectMaterials.map(m => ({
    value: m.uuid,
    label: m.name,
    group: 'Материалы объекта'
  }))
]
```

### 3. Обратная совместимость
- Сохранена поддержка старого поля `material.color`
- Отображается информация о fallback цвете если он есть
- Логика резолвинга в рендеринге остается неизменной

### 4. UX улучшения
- Поиск по названию материалов
- Возможность очистки выбора
- Группировка для удобной навигации
- Высокий z-index для корректного отображения выпадающего списка

## Результат

PrimitiveControlPanel теперь поддерживает выбор материалов из единого селектора, который показывает как глобальные, так и материалы объекта. Реализована корректная логика применения материалов к примитиву с сохранением обратной совместимости для старой системы материалов.

## Тестирование

- ✅ Проект собирается без ошибок (`npm run build`)
- ✅ TypeScript типы корректны
- ✅ Импорты и зависимости разрешаются

## Контекст для следующих фаз

Фаза 6E завершает рефакторинг UI компонентов для работы с новой системой материалов. PrimitiveControlPanel теперь полностью интегрирован с системой материалов и готов для работы с материалами объекта и глобальными материалами.

Следующие фазы могут включать:
- Обновление CAD конвертера (Фаза 7)
- Миграцию существующих данных (Фаза 8)  
- Обновление документации (Фаза 9)