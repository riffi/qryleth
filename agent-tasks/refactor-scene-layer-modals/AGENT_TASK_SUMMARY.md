# Рефакторинг SceneLayerModals: Объединение в единое окно

**Ссылка на инструкции:** [agent-tasks.md](../../docs/development/workflows/agent-tasks.md)

## Контекст задачи

В компоненте `SceneLayerModals` сейчас существует два отдельных модальных окна для создания и редактирования слоев. Это приводит к дублированию кода и созданию множества переменных состояния в контексте для хранения данных каждого из окон отдельно.

### Текущие проблемы:

1. **Дублирование переменных состояния**: В контексте есть отдельные переменные для создания (`newLayer*`) и редактирования (`editingLayer*`)
2. **Дублирование компонентов UI**: Две модалки с почти идентичной структурой полей
3. **Сложность поддержки**: Изменения в логике требуют правок в двух местах

### Цель рефакторинга:

1. Объединить два модальных окна в одно универсальное
2. Использовать единый объект для хранения данных слоя вместо отдельных переменных
3. Скрывать поле типа при редактировании существующего слоя
4. Упростить контекст, убрав лишние переменные

## План выполнения

### Фаза 1: Обновление типов и интерфейсов
**Статус:** Ожидается выполнения

- Использовать существующий тип `SceneLayer` для хранения информации о создаваемом/изменяемом слое
- Обновить типы в `types.ts` для поддержки единого модального окна
- Определить тип режима работы модального окна ('create' | 'edit') 
- Добавить утилитарные функции для работы с формой и создания пустого слоя

### Фаза 2: Рефакторинг типов и контекста
**Статус:** Ожидается выполнения

- Обновить интерфейс `SceneObjectManagerContextValue` в `types.ts`
- Заменить отдельные переменные состояния (всего 18 переменных для двух форм) на единую структуру
- Добавить переменные `layerModalOpened`, `layerModalMode`, `layerFormData: SceneLayer`
- Удалить устаревшие переменные из интерфейса

### Фаза 3: Рефакторинг основного компонента SceneObjectManager
**Статус:** Ожидается выполнения

- Заменить все состояния слоев (строки 52-65) на единую структуру
- Обновить функции `handleCreateLayer` и `handleUpdateLayer` для работы с новой структурой
- Обновить `openEditLayerModal` для заполнения единой структуры данных
- Обновить провайдер контекста для передачи новых переменных

### Фаза 4: Рефакторинг компонента SceneLayerModals
**Статус:** Ожидается выполнения

- Объединить два модальных окна в одно (удалить ~130 строк дублированного кода)
- Реализовать условное отображение полей в зависимости от режима
- Скрыть поле типа слоя при редактировании
- Обновить обработчики событий для работы с единой структурой данных
- Обновить логику сброса формы

### Фаза 5: Тестирование и финальная проверка
**Статус:** Ожидается выполнения

- Проверить работу создания новых слоев всех типов (object, landscape, water)
- Проверить работу редактирования существующих слоев
- Убедиться, что поле типа скрыто при редактировании
- Проверить корректность пресетов размеров для landscape слоев
- Проверить корректность сброса формы при закрытии модального окна

## Файлы, которые будут изменены:

1. `src/features/scene/ui/objectManager/types.ts` - обновление типов контекста
2. `src/features/scene/ui/objectManager/SceneObjectManager.tsx` - основной компонент (670+ строк)
3. `src/features/scene/ui/objectManager/SceneLayerModals.tsx` - компонент модальных окон (380+ строк)
4. `src/features/scene/ui/objectManager/SceneObjectManagerContext.tsx` - контекст (минимальные изменения)

## Детальный анализ текущего состояния

### Переменные, которые будут объединены:

**Для создания слоя (8 переменных):**
- `newLayerName: string`
- `newLayerType: 'object' | 'landscape' | 'water'`
- `newLayerWidth: number`
- `newLayerHeight: number`
- `newLayerShape: 'plane' | 'perlin'`
- `newLayerColor: string`
- `createLayerModalOpened: boolean`
- `handleCreateLayer: () => void`

**Для редактирования слоя (10 переменных):**
- `editLayerModalOpened: boolean`
- `editingLayerId: string` (в основном компоненте)
- `editingLayerType: 'object' | 'landscape' | 'water'`
- `editingLayerWidth: number`
- `editingLayerHeight: number`
- `editingLayerShape: 'plane' | 'perlin'`
- `editingLayerColor: string`
- `handleUpdateLayer: () => void`
- `openEditLayerModal: (layer: SceneLayer) => void`

### Новая структура (3 переменные):
- `layerModalOpened: boolean`
- `layerModalMode: 'create' | 'edit'`
- `layerFormData: SceneLayer` - использует стандартный тип из системы

### Преимущества использования SceneLayer:
- ✅ Уже содержит все необходимые поля формы (name, type, width, height, shape, color)
- ✅ Типобезопасность - нет дублирования типов
- ✅ Простота интеграции с существующими функциями создания/обновления слоев
- ✅ Автоматическая совместимость с остальной системой

## Принципы архитектуры

При выполнении задачи следует руководствоваться [принципами архитектуры](../../docs/architecture/design-principles.md):
- Минимизация дублирования кода
- Единая ответственность компонентов
- Типобезопасность TypeScript
- Читаемость и поддерживаемость кода