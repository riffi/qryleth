# Агентская задача: Группировка примитивов GfxObject

## Обязательная информация
!Правила работы с агентскими задачами: [agent-tasks.md](../../docs/development/workflows/agent-tasks.md)
**ВАЖНО**: При выполнении каждой из фаз необходимо обязательно сверяться с требованиями и принципами из указанного файла.

## Контекст задачи

В настоящее время в GfxObject примитивы хранятся в обычном массиве `primitives: GfxPrimitive[]`. Это создает ограничения для пользователей, которые хотят логически группировать примитивы для удобства работы с большими и сложными объектами.

**Важный use case**: В будущем планируется реализация импорта объектов из библиотеки внутрь текущего редактируемого объекта. При импорте объекта (например, "дом") должна создаваться группа примитивов, и туда копироваться все примитивы из импортируемого объекта. Если импортируемый объект уже содержит группы (например, "фундамент", "стены", "крыша"), то эта иерархическая структура должна сохраняться внутри созданной группы импорта. Это требует **иерархической**, а не плоской структуры групп.

### Текущая структура GfxObject

```typescript
export interface GfxObject {
  uuid: string;
  name: string;
  primitives: GfxPrimitive[];
  materials?: GfxMaterial[];
  boundingBox?: BoundingBox;
}
```

### Анализ существующих компонентов

**PrimitiveManager** (`src/features/object-editor/ui/PrimitiveManager/PrimitiveManager.tsx`):
- Отображает плоский список примитивов
- Поддерживает выделение, скрытие/показ, удаление примитивов
- Работает с индексами примитивов в массиве

**ObjectScenePrimitives** (`src/features/object-editor/ui/renderer/objects/ObjectScenePrimitives.tsx`):
- Рендерит примитивы через map по массиву
- Обрабатывает клики и передает индексы примитивов

**Tools системы**:
- objectEditor имеет tools в `src/features/object-editor/lib/ai/tools/objectTools.ts`
- sceneEditor имеет tools в `src/features/scene/lib/ai/tools/objectTools.ts`

## Цели задачи

1. **Реализовать опциональную группировку примитивов** - возможность создания групп и добавления в них примитивов
2. **Иерархическая структура групп** - поддержка вложенных групп для импорта объектов с существующими группами
3. **Интеграция с tools** - поддержка группировки в sceneEditor и objectEditor tools
4. **Обновление рендеринга** - учет группировки при рендеринге в обоих редакторах
5. **Расширение PrimitiveManager** - UI для управления группами
6. **UUID и имена групп** - каждая группа должна иметь uuid и name

## Планируемая структура данных

```typescript
export interface PrimitiveGroup {
  uuid: string;
  name: string;
  visible?: boolean;
  // Поддержка иерархии - ссылка на родительскую группу
  parentGroupUuid?: string;
  // Дополнительные свойства для импортированных групп
  isImported?: boolean;
  sourceObjectUuid?: string; // UUID исходного объекта при импорте
}

export interface GfxObject {
  uuid: string;
  name: string;
  primitives: GfxPrimitive[];
  // Новые опциональные поля
  primitiveGroups?: PrimitiveGroup[];
  // Расширенная информация о примитивах с указанием группы
  primitiveGroupAssignments?: Record<number, string>; // primitiveIndex -> groupUuid
  materials?: GfxMaterial[];
  boundingBox?: BoundingBox;
}
```

## План выполнения задачи по фазам

### Фаза 1: Расширение типов и моделей данных
**Статус**: Не выполнено

**Описание**: Расширить интерфейс GfxObject для поддержки групп примитивов, обновить связанные типы и модели.

**Детальные действия**:
- Добавить интерфейс `PrimitiveGroup` с полями uuid, name, visible, parentGroupUuid, isImported, sourceObjectUuid
- Расширить интерфейс `GfxObject` полями `primitiveGroups` и `primitiveGroupAssignments`
- Обновить типы в entities/object
- Добавить вспомогательные утилиты для работы с иерархическими группами примитивов
- Добавить утилиты для импорта объектов с сохранением структуры групп

**Файлы для изменения**:
- `src/entities/object/model/types.ts`
- Возможно создание `src/entities/primitiveGroup/` (по аналогии с другими entities)

### Фаза 2: Обновление objectStore для поддержки групп
**Статус**: Не выполнено

**Описание**: Расширить zustand store объект-редактора для управления группами примитивов.

**Детальные действия**:
- Добавить состояние для выбранных групп
- Реализовать actions для создания, удаления, переименования групп  
- Реализовать actions для назначения примитивов в группы
- Реализовать actions для работы с иерархией групп (создание подгрупп, перемещение между уровнями)
- Реализовать action для импорта объекта с сохранением структуры групп
- Добавить селекторы для получения группированных примитивов с учетом иерархии
- Обновить существующие селекторы с учетом групп

**Файлы для изменения**:
- `src/features/object-editor/model/objectStore.ts`

### Фаза 3: Расширение UI PrimitiveManager для групп
**Статус**: Не выполнено

**Описание**: Добавить в PrimitiveManager возможность отображения групп, создания новых групп, управления группами.

**Детальные действия**:
- Создать компонент `PrimitiveGroupItem` для отображения группы с поддержкой иерархии
- Добавить древовидное отображение групп с возможностью сворачивания/разворачивания
- Добавить UI для создания новой группы и подгруппы
- Реализовать drag-and-drop для перемещения примитивов между группами и уровнями иерархии
- Добавить контекстное меню для управления группами (создать подгруппу, переместить в другую группу)
- Обновить отображение примитивов с учетом принадлежности к иерархическим группам
- Добавить индикаторы для импортированных групп

**Файлы для изменения**:
- `src/features/object-editor/ui/PrimitiveManager/PrimitiveManager.tsx`
- Возможно создание дополнительных компонентов в той же папке

### Фаза 4: Обновление рендеринга в ObjectEditor
**Статус**: Не выполнено

**Описание**: Модифицировать компоненты рендеринга объект-редактора для поддержки группировки примитивов.

**Детальные действия**:
- Обновить `ObjectScenePrimitives` для рендеринга по иерархическим группам
- **Рендерить каждую группу примитивов как отдельный `<group>` Three.js Fiber компонент с поддержкой вложенности**
- Создать рекурсивную структуру `<group>` элементов для иерархии групп
- Примитивы внутри группы должны быть дочерними элементами соответствующего `<group>`
- Примитивы без группы должны рендериться на верхнем уровне как раньше
- Добавить возможность скрытия/показа целых групп через `visible` свойство группы (с наследованием вниз по иерархии)
- Обновить логику выделения с учетом иерархических групп
- Сохранить обратную совместимость с объектами без групп

**Файлы для изменения**:
- `src/features/object-editor/ui/renderer/objects/ObjectScenePrimitives.tsx`

### Фаза 5: Обновление рендеринга в SceneEditor  
**Статус**: Не выполнено

**Описание**: Модифицировать компоненты рендеринга сцен-редактора для поддержки группировки примитивов.

**Детальные действия**:
- Обновить рендеринг объектов в сцене с учетом иерархических групп примитивов
- **Рендерить группы примитивов как вложенные `<group>` Three.js Fiber компоненты внутри объектов**
- Убедиться что иерархия групп правильно обрабатывается при рендеринге инстансов объектов
- Сохранить производительность рендеринга с учетом возможной глубокой вложенности

**Файлы для изменения**:
- `src/features/scene/ui/renderer/objects/SceneObjectRenderer.tsx`
- Возможно другие файлы в renderer/objects/

### Фаза 6: Расширение tools для objectEditor
**Статус**: Не выполнено

**Описание**: Добавить AI tools для управления группами примитивов в объект-редакторе.

**Детальные действия**:
- Создать tool `createPrimitiveGroup` для создания новой группы (с опциональным parentGroupUuid)
- Создать tool `assignPrimitiveToGroup` для назначения примитива в группу  
- Создать tool `removePrimitiveGroup` для удаления группы (с обработкой подгрупп)
- Создать tool `renamePrimitiveGroup` для переименования группы
- Создать tool `importObjectAsGroup` для импорта другого объекта как группы
- Обновить существующие tools с учетом иерархических групп

**Файлы для изменения**:
- `src/features/object-editor/lib/ai/tools/objectTools.ts`
- Возможно создание `src/features/object-editor/lib/ai/tools/primitiveGroupTools.ts`

### Фаза 7: Расширение tools для sceneEditor
**Статус**: Не выполнено

**Описание**: Добавить AI tools для работы с группами примитивов в сцен-редакторе.

**Детальные действия**:
- Обновить существующие object tools с поддержкой иерархических групп
- Убедиться что создание объектов через AI правильно обрабатывает группы
- Добавить возможность AI создавать объекты с предустановленными иерархическими группами
- Добавить поддержку импорта объектов из библиотеки с сохранением структуры групп

**Файлы для изменения**:
- `src/features/scene/lib/ai/tools/objectTools.ts`

### Фаза 8: Обновление objectEditorApi
**Статус**: Не выполнено

**Описание**: Расширить API объект-редактора для поддержки операций с группами.

**Детальные действия**:
- Добавить методы для работы с группами в objectEditorApi
- Обеспечить правильную интеграцию с tools системой
- Обновить существующие API методы с учетом групп

**Файлы для изменения**:
- `src/features/object-editor/lib/objectEditorApi.ts`

### Фаза 9: Реализация импорта объектов как групп
**Статус**: Не выполнено

**Описание**: Реализовать функциональность импорта объектов из библиотеки внутрь текущего объекта с созданием группы и сохранением иерархии.

**Детальные действия**:
- Создать функцию импорта объекта с преобразованием в группу примитивов
- Реализовать сохранение существующей иерархии групп импортируемого объекта
- Добавить обработку конфликтов имен групп при импорте
- Добавить UI для выбора объекта из библиотеки для импорта
- Реализовать предварительный просмотр структуры групп импортируемого объекта

**Файлы для изменения**:
- `src/features/object-editor/lib/objectEditorApi.ts`
- `src/features/object-editor/ui/ObjectManagementPanel/` (новые компоненты)

### Фаза 10: Обновление документации
**Статус**: Не выполнено

**Описание**: Обновить проектную документацию с учетом новой функциональности группировки примитивов.

**Детальные действия**:
- Обновить API документацию
- Добавить примеры использования иерархических групп примитивов
- Документировать процесс импорта объектов как групп
- Обновить архитектурную документацию

**Файлы для изменения**:
- `docs/api/types/README.md`  
- `docs/features/object-editing/README.md`
- Возможно другие файлы документации

## Принципы реализации

1. **Обратная совместимость**: Объекты без групп должны продолжать работать как раньше
2. **Иерархическая структура**: Поддержка вложенных групп для импорта объектов с сохранением структуры
3. **Производительность**: Группировка не должна значительно влиять на производительность рендеринга
4. **FSD архитектура**: Следовать принципам Feature-Sliced Design
5. **Type Safety**: Все новые интерфейсы должны быть типизированы
6. **Консистентность**: UI и UX должны быть консистентны с существующими компонентами
7. **Импорт объектов**: Обеспечить полное сохранение структуры групп при импорте

## Связанные файлы и документация

- [Design Principles](../../docs/architecture/design-principles.md) - Архитектурные принципы
- [Object Editing Documentation](../../docs/features/object-editing/README.md) - Документация по редактированию объектов
- [Types Documentation](../../docs/api/types/README.md) - Документация по типам API

## Примечания

- Каждая фаза должна быть реализована так, чтобы приложение собиралось и работало корректно
- При возникновении необходимости изменения более 15 файлов в одной фазе, следует разбить фазу на более мелкие
- Тестирование изменений должно проводиться после каждой фазы