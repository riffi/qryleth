# Агентская задача: Перевод чата с агентом на LangChain и добавление инструментов для работы со сценой

**Ссылка на инструкции:** [agent-tasks.md](../../docs/development/workflows/agent-tasks.md) - обязательно сверяться с требованиями при выполнении каждой из фаз.

## Контекст задачи

Текущая реализация чата с AI агентом использует прямые API вызовы к OpenAI-совместимым сервисам через `fetchWithTools`. Задача состоит в переводе этой архитектуры на LangChain для более гибкого управления инструментами и добавлении новых возможностей для работы со сценой.

### Текущая архитектура чата:

**Основные компоненты:**
- `src/widgets/ChatInterface.tsx` - UI компонент чата  
- `src/shared/lib/openAIAPI.ts` - API клиент с типами и инструментами
- `src/shared/lib/openAISettings.ts` - управление подключениями к AI провайдерам
- `src/widgets/OpenAISettingsModal.tsx` - настройки подключений

**Текущие инструменты:**
- `add_new_object` - добавление нового объекта в сцену

**Архитектурные принципы (из docs/architecture/design-principles.md):**
- Feature-Sliced Design с четкой иерархией слоев
- AI агенты работают только через публичные API store'ов
- Zustand для управления состоянием сцены
- Соблюдение правил доступа между слоями

### Целевые инструменты для реализации:

1. **Получение списка объектов сцены** - для анализа текущего состояния
2. **Добавление экземпляра объекта на сцену** - размещение существующих объектов

## План выполнения задачи

### Фаза 1: Подготовка инфраструктуры LangChain
**Статус:** Ожидает выполнения

**Описание:** Установка и настройка LangChain зависимостей, создание базовой конфигурации для интеграции с существующими провайдерами AI.

**Планируемые изменения:**
- Установка `@langchain/core`, `@langchain/openai`, `@langchain/community`
- Создание `src/shared/lib/langchain/` с базовой конфигурацией
- Создание адаптера для существующих подключений OpenAI
- Обновление типов данных для совместимости с LangChain

**Файлы для изменения (~8 файлов):**
- `package.json` - добавление зависимостей
- `src/shared/lib/langchain/config.ts` - конфигурация LangChain
- `src/shared/lib/langchain/adapters.ts` - адаптеры для провайдеров
- `src/shared/lib/langchain/types.ts` - типы данных
- `src/shared/lib/openAISettings.ts` - адаптация существующих настроек

### Фаза 2: Создание инструментов для работы со сценой
**Статус:** Ожидает выполнения

**Описание:** Реализация новых LangChain инструментов для получения информации о сцене и добавления экземпляров объектов.

**Планируемые изменения:**
- Создание инструмента `get_scene_objects` для получения списка объектов сцены
- Создание инструмента `add_object_instance` для добавления экземпляра существующего объекта
- Интеграция с Zustand store для доступа к данным сцены
- Реализация валидации и обработки ошибок для новых инструментов

**Файлы для изменения (~6 файлов):**
- `src/shared/lib/langchain/tools/sceneTools.ts` - новые инструменты
- `src/shared/lib/langchain/tools/index.ts` - экспорт инструментов
- `src/features/scene/lib/sceneAPI.ts` - API для доступа к данным сцены
- Обновление типов в `src/entities/` для поддержки новых операций

### Фаза 3: Перевод существующих инструментов на LangChain
**Статус:** Ожидает выполнения  

**Описание:** Адаптация существующего инструмента `add_new_object` для работы с LangChain архитектурой.

**Планируемые изменения:**
- Перевод `add_new_object` на LangChain Tool API
- Сохранение совместимости с существующими вызовами
- Обновление схемы валидации параметров
- Адаптация обработки ошибок

**Файлы для изменения (~5 файлов):**
- `src/shared/lib/langchain/tools/objectTools.ts` - адаптированный инструмент
- Обновление `src/shared/lib/openAIAPI.ts` для использования LangChain
- Обновление типов и интерфейсов

### Фаза 4: Интеграция LangChain в ChatInterface
**Статус:** Ожидает выполнения

**Описание:** Замена прямых API вызовов на LangChain в интерфейсе чата с сохранением всей существующей функциональности.

**Планируемые изменения:**
- Замена `fetchWithTools` на LangChain agent
- Обновление обработки tool calls через LangChain
- Сохранение debug режима с LangChain совместимостью
- Обновление типов сообщений и ответов

**Файлы для изменения (~7 файлов):**
- `src/widgets/ChatInterface.tsx` - основная интеграция
- `src/shared/lib/langchain/chatService.ts` - сервис для чата
- Обновление обработки ошибок и UI состояний
- Обновление типов в shared/lib

### Фаза 5: Тестирование и финализация
**Статус:** Ожидает выполнения

**Описание:** Комплексное тестирование новой функциональности, обеспечение обратной совместимости и оптимизация производительности.

**Планируемые изменения:**
- Создание тестов для новых инструментов
- Проверка работы с различными AI провайдерами
- Тестирование debug режима
- Оптимизация производительности LangChain интеграции
- Обновление документации

**Файлы для изменения (~5 файлов):**
- Тесты в `src/shared/lib/langchain/__tests__/`
- Обновление документации в `docs/features/ai-integration/`
- Финализация типов и интерфейсов

### Фаза 6: Актуализация документации
**Статус:** Ожидает выполнения

**Описание:** Обновление технической документации с учетом новой LangChain архитектуры.

**Планируемые изменения:**
- Обновление `docs/features/ai-integration/llm-integration.md`
- Создание руководства по новым инструментам
- Обновление архитектурной документации
- Примеры использования новых возможностей

**Файлы для изменения (~3 файла):**
- `docs/features/ai-integration/llm-integration.md`
- `docs/features/ai-integration/langchain-tools.md` (новый)
- Обновление примеров в документации

## Общие требования

- Сохранение обратной совместимости с существующими подключениями AI
- Соблюдение Feature-Sliced Design принципов
- Обеспечение типобезопасности TypeScript
- Сохранение производительности приложения
- Поддержка всех существующих AI провайдеров (OpenRouter, OpenAI, совместимые)

## Ожидаемые результаты

После выполнения всех фаз:
1. Чат с агентом будет работать через LangChain
2. Агент сможет получать список объектов текущей сцены
3. Агент сможет добавлять экземпляры существующих объектов на сцену
4. Сохранится полная функциональность существующего чата
5. Будет актуализирована документация