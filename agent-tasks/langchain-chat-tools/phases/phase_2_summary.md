# Фаза 2: Создание инструментов для работы со сценой

**Статус:** Выполнено  
**Дата выполнения:** 2025-07-23

## Выполненные задачи

### 1. Анализ архитектуры сцены

Проведен детальный анализ существующих APIs для работы со сценой:
- **Scene Store**: Zustand-based store в `src/features/scene/model/sceneStore.ts`
- **Типы данных**: `SceneObject`, `SceneObjectInstance`, `SceneLayer` и связанные типы
- **Доступные методы**: `addObject()`, `addObjectInstance()`, `removeObject()`, `removeObjectInstance()` и др.
- **Оптимизированные селекторы**: для производительности с `shallow` сравнением

### 2. Создание Scene API для агентов

Создан модуль `src/features/scene/lib/sceneAPI.ts` с публичным API для доступа агентов к данным сцены:

#### Основные методы:
- `getSceneOverview()` - полная информация о сцене
- `getSceneObjects()` - список объектов с метаданными  
- `findObjectByUuid()` - поиск по UUID
- `findObjectByName()` - поиск по имени
- `addObjectInstance()` - добавление экземпляра объекта
- `canAddInstance()` - проверка возможности добавления
- `getSceneStats()` - статистика сцены

#### Типы данных для агентов:
- `SceneObjectInfo` - упрощенная информация об объекте
- `SceneInstanceInfo` - информация об экземпляре  
- `SceneOverview` - обзор всей сцены
- `AddInstanceResult` - результат операции добавления

### 3. Создание LangChain инструментов

Созданы 6 LangChain инструментов в `src/shared/lib/langchain/tools/`:

#### Информационные инструменты (`sceneTools.ts`):
1. **`get_scene_objects`** - получение списка всех объектов сцены с метаданными
2. **`get_scene_stats`** - получение статистики сцены  
3. **`find_object_by_name`** - поиск объекта по имени

#### Инструменты управления экземплярами (`instanceTools.ts`):
4. **`add_object_instance`** - добавление экземпляра существующего объекта
5. **`can_add_instance`** - проверка возможности добавления экземпляра
6. **`get_object_instances`** - получение списка экземпляров объекта

### 4. Интеграция с LangChain сервисом

Обновлен `src/shared/lib/langchain/chatService.ts`:
- Добавлен метод `registerDynamicTool()` для регистрации DynamicTool экземпляров
- Добавлен метод `registerSceneTools()` для автоматической регистрации инструментов сцены
- Добавлен метод `getRegisteredTools()` для отладки
- Инструменты автоматически регистрируются при инициализации сервиса

### 5. Модульная организация

Создана структура модулей:
- `src/shared/lib/langchain/tools/index.ts` - экспорт всех инструментов
- `src/shared/lib/langchain/tools/sceneTools.ts` - информационные инструменты
- `src/shared/lib/langchain/tools/instanceTools.ts` - инструменты управления экземплярами

Обновлен `src/shared/lib/langchain/index.ts` для экспорта новых инструментов.

## Результаты тестирования

- ✅ Проект успешно собирается (`npm run build`)
- ✅ Все новые модули корректно импортируются
- ✅ TypeScript типизация работает без ошибок
- ✅ Инструменты автоматически регистрируются в LangChain сервисе

## Особенности реализации

### Валидация параметров
- Используется `zod` для валидации параметров в `add_object_instance`
- Проверка существования объектов перед добавлением экземпляров
- Детальная обработка ошибок с понятными сообщениями

### Безопасность и производительность
- Использование оптимизированных селекторов для доступа к данным store
- Проверка существования объектов перед операциями
- Генерация UUID для новых экземпляров через существующую утилиту

### Удобство для агентов
- JSON-формат всех ответов для легкого парсинга
- Подробные описания инструментов для LLM
- Информативные сообщения об ошибках

## Контекст для следующих фаз

### Доступные инструменты для агентов:
1. **get_scene_objects** - получить все объекты сцены
2. **get_scene_stats** - получить статистику сцены
3. **find_object_by_name** - найти объект по имени
4. **add_object_instance** - добавить экземпляр объекта
5. **can_add_instance** - проверить возможность добавления
6. **get_object_instances** - получить экземпляры объекта

### Интеграция с существующей архитектурой:
- Все инструменты автоматически регистрируются при инициализации `langChainChatService`
- Сохранена совместимость с существующим кодом
- Соблюдены принципы Feature-Sliced Design

### Готово для следующей фазы:
Инфраструктура готова для перевода существующего инструмента `add_new_object` на LangChain архитектуру.

## Файлы, созданные в этой фазе:
- `src/features/scene/lib/sceneAPI.ts` - API для доступа агентов к сцене
- `src/shared/lib/langchain/tools/sceneTools.ts` - информационные инструменты  
- `src/shared/lib/langchain/tools/instanceTools.ts` - инструменты управления экземплярами
- `src/shared/lib/langchain/tools/index.ts` - экспорт инструментов

## Файлы, измененные в этой фазе:
- `src/shared/lib/langchain/chatService.ts` - добавлены методы регистрации инструментов
- `src/shared/lib/langchain/index.ts` - добавлен экспорт инструментов